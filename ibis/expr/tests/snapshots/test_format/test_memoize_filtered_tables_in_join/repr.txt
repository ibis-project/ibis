r0 := UnboundTable: purchases
  region string
  kind   string
  user   int64
  amount float64

r1 := Aggregate[r0]
  groups:
    region: r0.region
    kind:   r0.kind
  metrics:
    total: Sum(r0.amount)

r2 := Filter[r1]
  r1.kind == 'foo'

r3 := Filter[r1]
  r1.kind == 'bar'

r4 := SelfReference[r3]

JoinChain[r2]
  JoinLink[inner, r4]
    r2.region == r4.region
  values:
    region:      r2.region
    kind:        r2.kind
    total:       r2.total
    right_total: r4.total