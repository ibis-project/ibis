version: 2


test: &test
  machine:
    image: circleci/classic:latest
    docker_layer_caching: true
  working_directory: ~/ibis/ci
  steps:
    - checkout:
        path: ~/ibis

    - run:
        name: Setup Google Credentials for BigQuery
        command: |
          if [ -n "${GCLOUD_SERVICE_KEY}" ]; then
            echo "${GCLOUD_SERVICE_KEY}" | base64 --decode --ignore-garbage > /tmp/ibis/gcloud-service-key.json
          fi
    - run: ls $HOME
    # - run:
    #     name: Start Databases
    #     command: docker-compose up -d --no-build postgres impala clickhouse
    # - run:
    #     name: Show Running Containers
    #     command: docker ps
    # - run:
    #     name: Build Ibis
    #     command: docker-compose build --pull ibis
    # - run:
    #     name: Flake8
    #     command: docker-compose run ibis flake8
    # - run:
    #     name: Wait for Databases
    #     command: docker-compose run waiter
    # - run:
    #     name: Load Test Datasets
    #     command: docker-compose run ibis bash ci/load-data.sh
    # - run:
    #     name: Execute Pytest
    #     command: |
    #       docker-compose run ibis pytest -rsxX \
    #         --doctest-modules \
    #         --doctest-ignore-import-errors \
    #         --tb=short ibis/bigquery


jobs:
  python27_test:
    <<: *test
    environment:
      - PYTHON_VERSION: 2.7

  python34_test:
    <<: *test
    environment:
      - PYTHON_VERSION: 3.4

  python35_test:
    <<: *test
    environment:
      - PYTHON_VERSION: 3.5

  python36_test:
    <<: *test
    environment:
      - PYTHON_VERSION: 3.6


workflows:
  version: 2
  test:
    jobs:
      - python27_test
      # - python34_test
      # - python35_test
      # - python36_test

