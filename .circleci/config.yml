version: 2

jobs:
  test:
    machine:
      image: circleci/classic:latest
      docker_layer_caching: true

    environment:
      - PYTHON_VERSION: 3.6
    steps:
      - checkout
      # - attach_workspace:
      #     at: /tmp/workspace
      - run: ls -lah
      - run: sudo apt-get update -y && sudo apt-get install -qq clang libboost-dev
      - run: mkdir -p /tmp/workspace
      - run: curl -o $HOME/miniconda.sh https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
      - run: bash $HOME/miniconda.sh -b -p /tmp/workspace/miniconda
      - run: export PATH="/tmp/workspace/miniconda/bin:$PATH"
      - run: echo $PATH
      - run: ls -lah /tmp/workspace/miniconda/bin
      - run: which conda
      # - persist_to_workspace:
      #     root: /tmp/workspace
      #     paths:
      #       - miniconda
      - run: |
          conda env create --quiet \
            --name "${ENV_NAME}" \
            --file "ci/requirements-dev-${PYTHON_VERSION}.yml"
      - run: echo 'source activate ${ENV_NAME}' | tee -a $BASH_ENV
      - run: flake8
      - run: cd testing; bash start-all.sh



workflows:
  version: 2
  test:
    jobs:
      - test

