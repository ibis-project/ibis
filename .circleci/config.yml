version: 2


base: &base
  machine:
    image: circleci/classic:latest
    docker_layer_caching: true
  working_directory: ~/ibis/ci


test: &test
  <<: *base
  steps:
    - checkout:
        path: ~/ibis
    - run:
        name: Setup Google Credentials for BigQuery
        command: |
          if [ -n "${GCLOUD_SERVICE_KEY}" ]; then
            mkdir -p /tmp/ibis
            echo "${GCLOUD_SERVICE_KEY}" | base64 --decode --ignore-garbage > /tmp/ibis/gcloud-service-key.json
          fi
    - run:
        name: Start Databases
        command: docker-compose up -d --no-build postgres impala clickhouse
    - run:
        name: Show Running Containers
        command: docker ps
    - run:
        name: Build Ibis Image
        command: docker-compose build --pull ibis
    - run:
        name: List Docker Images
        command: docker images
    - run:
        name: Flake8
        command: docker-compose run ibis flake8
    - run:
        name: Wait for Databases
        command: docker-compose run waiter
    - run:
        name: Load Test Datasets
        command: docker-compose run ibis ci/load-data.sh
    - run:
        name: Execute Pytest
        command: |
          docker-compose run ibis pytest -rsxX \
            --doctest-modules \
            --doctest-ignore-import-errors \
            --tb=short -m "not udf" ibis


build: &build
  <<: *base
  steps:
    - checkout:
        path: ~/ibis
    - run:
        name: Build Ibis Image
        command: docker-compose build --pull ibis
    - run:
        name: List Docker Images
        command: docker images
    - run:
        name: Build Conda Recipe
        command: |
          docker-compose run ibis conda build conda-recipes/ibis-framework \
            --python "${PYTHON_VERSION}" \
            --channel conda-forge


benchmark: &benchmark
  <<: *base
  steps:
    - checkout:
        path: ~/ibis
    - run:
        name: Build Ibis Image
        command: docker-compose build --pull ibis
    - run:
        name: Run Benchmark (ASV)
        command: |
          docker-compose run ibis ci/benchmark.sh circle "${CIRCLE_SHA1}"


jobs:
  python27_test:
    <<: *test
    environment:
      - PYTHON_VERSION: 2.7

  python34_test:
    <<: *test
    environment:
      - PYTHON_VERSION: 3.4

  python35_test:
    <<: *test
    environment:
      - PYTHON_VERSION: 3.5

  python36_test:
    <<: *test
    environment:
      - PYTHON_VERSION: 3.6

  python27_conda_build:
    <<: *build
    environment:
      - PYTHON_VERSION: 2.7

  python34_conda_build:
    <<: *build
    environment:
      - PYTHON_VERSION: 3.4

  python35_conda_build:
    <<: *build
    environment:
      - PYTHON_VERSION: 3.5

  python36_conda_build:
    <<: *build
    environment:
      - PYTHON_VERSION: 3.6

  python36_benchmark:
    <<: *benchmark
    environment:
      - PYTHON_VERSION: 3.6


workflows:
  version: 2
  test:
    jobs:
      - python27_test
      - python34_test
      - python35_test
      - python36_test

      - python27_conda_build
      - python34_conda_build
      - python35_conda_build
      - python36_conda_build

      - python36_benchmark


