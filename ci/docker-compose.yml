version: '3'
services:

  postgres:
    image: postgres
    ports:
      - 5432:5432
    environment:
      POSTGRES_PASSWORD: postgres

  impala:
    image: ibisproject/impala
    links:
      - postgres
    depends_on:
      - postgres
    environment:
      PGPASSWORD: postgres
    ports:
      # HDFS
      - 9020:9020
      - 50070:50070
      - 50075:50075
      - 8020:8020
      - 8042:8042
      # Hive
      - 9083:9083
      # Impala
      - 21000:21000
      - 21050:21050
      - 25000:25000
      - 25010:25010
      - 25020:25020

  clickhouse:
    image: yandex/clickhouse-server:latest
    ports:
      - 8123:8123
      - 9000:9000

  ibis:
    image: ibis
    links:
      - impala
      - postgres
      - clickhouse
    environment:
      - IBIS_TEST_NN_HOST=impala
      - IBIS_TEST_IMPALA_HOST=impala
      - IBIS_TEST_POSTGRES_HOST=postgres
      - IBIS_TEST_POSTGRES_PASSWORD=postgres
      - IBIS_TEST_CLICKHOUSE_HOST=clickhouse
    volumes:
      - /tmp/ibis:/tmp
    build:
      context: ..
      dockerfile: ci/Dockerfile
      args:
        python: ${PYTHON_VERSION}

  waiter:
    image: jwilder/dockerize
    links:
      - impala
      - postgres
      - clickhouse
    command: |
      dockerize -wait tcp://postgres:5432
                -wait tcp://impala:21050
                -wait tcp://impala:50070
                -wait tcp://clickhouse:9000
                -timeout 5m
