<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.339">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Ibis – ibis-for-sql-users</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../logo.svg" rel="icon" type="image/svg+xml">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "keyboard-shortcut": [
    null
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../logo.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ibis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-getting-started" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Getting started</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-getting-started">    
        <li>
    <a class="dropdown-item" href="../install.html">
 <span class="dropdown-text">Installation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/getting_started.html">
 <span class="dropdown-text">Tutorial: getting started</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/ibis-for-dplyr-users.html">
 <span class="dropdown-text">Tutorial: Ibis for dplyr users</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/ibis-for-pandas-users.html">
 <span class="dropdown-text">Tutorial: Ibis for pandas users</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/ibis-for-sql-users.html">
 <span class="dropdown-text">Tutorial: Ibis for SQL users</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Data Platforms</li>
        <li>
    <a class="dropdown-item" href="../tutorials/data-platforms/starburst-galaxy/0_setup.html">
 <span class="dropdown-text">Starburst Galaxy</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-concepts" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Concepts</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-concepts">    
        <li>
    <a class="dropdown-item" href="../why.html">
 <span class="dropdown-text">Why Ibis?</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../concepts/internals.html">
 <span class="dropdown-text">Internals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../concepts/versioning.html">
 <span class="dropdown-text">Versioning policy</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-backends" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Backends</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-backends">    
        <li>
    <a class="dropdown-item" href="../backends/bigquery.html">
 <span class="dropdown-text">BigQuery</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/clickhouse.html">
 <span class="dropdown-text">ClickHouse</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/dask.html">
 <span class="dropdown-text">Dask</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/datafusion.html">
 <span class="dropdown-text">DataFusion</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/druid.html">
 <span class="dropdown-text">Druid</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/duckdb.html">
 <span class="dropdown-text">DuckDB</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/exasol.html">
 <span class="dropdown-text">Exasol</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/impala.html">
 <span class="dropdown-text">Impala</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/mssql.html">
 <span class="dropdown-text">MSSQL</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/mysql.html">
 <span class="dropdown-text">MySQL</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/oracle.html">
 <span class="dropdown-text">Oracle</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/pandas.html">
 <span class="dropdown-text">pandas</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/polars.html">
 <span class="dropdown-text">Polars</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/postgresql.html">
 <span class="dropdown-text">PostgreSQL</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/pyspark.html">
 <span class="dropdown-text">PySpark</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/snowflake.html">
 <span class="dropdown-text">Snowflake</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/sqlite.html">
 <span class="dropdown-text">SQLite</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../backends/trino.html">
 <span class="dropdown-text">Trino</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../support_matrix.html">
 <span class="dropdown-text">Operation support matrix</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-how-to" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">How-to</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-how-to">    
        <li class="dropdown-header">Configure</li>
        <li>
    <a class="dropdown-item" href="../how-to/configure/basics.html">
 <span class="dropdown-text">Basic configuration</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Input Output</li>
        <li>
    <a class="dropdown-item" href="../how-to/input-output/basics.html">
 <span class="dropdown-text">Basic input/output</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/input-output/multiple-backends.html">
 <span class="dropdown-text">Work with multiple backends</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Analytics</li>
        <li>
    <a class="dropdown-item" href="../how-to/analytics/basics.html">
 <span class="dropdown-text">Basic analytics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/analytics/chain_expressions.html">
 <span class="dropdown-text">Chaining expressions</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Visualization</li>
        <li>
    <a class="dropdown-item" href="../how-to/visualization/altair.html">
 <span class="dropdown-text">Altair + Ibis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/visualization/matplotlib.html">
 <span class="dropdown-text">matplotlib + Ibis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/visualization/plotly.html">
 <span class="dropdown-text">Plotly + Ibis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/visualization/plotnine.html">
 <span class="dropdown-text">plotnine + Ibis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/visualization/seaborn.html">
 <span class="dropdown-text">seaborn + Ibis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/visualization/streamlit.html">
 <span class="dropdown-text">Streamlit + Ibis</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Extending</li>
        <li>
    <a class="dropdown-item" href="../how-to/extending/builtin.html">
 <span class="dropdown-text">Reference built-in functions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/extending/elementwise.html">
 <span class="dropdown-text">Add an elementwise operation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/extending/reduction.html">
 <span class="dropdown-text">Add a reduction operation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../how-to/extending/sql.html">
 <span class="dropdown-text">Using SQL strings with Ibis</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-reference" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Reference</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-reference">    
        <li class="dropdown-header">Expression API</li>
        <li>
    <a class="dropdown-item" href="../reference/expression-tables.html">
 <span class="dropdown-text">Table expressions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/selectors.html">
 <span class="dropdown-text">Column selectors</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/expression-generic.html">
 <span class="dropdown-text">Generic expressions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/expression-numeric.html">
 <span class="dropdown-text">Numeric and Boolean expressions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/expression-strings.html">
 <span class="dropdown-text">String expressions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/expression-temporal.html">
 <span class="dropdown-text">Temporal expressions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/expression-collections.html">
 <span class="dropdown-text">Collection expressions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/expression-geospatial.html">
 <span class="dropdown-text">Geospatial expressions</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Type system</li>
        <li>
    <a class="dropdown-item" href="../reference/datatypes.html">
 <span class="dropdown-text">Data types</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/schemas.html">
 <span class="dropdown-text">Schemas</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">UDFs</li>
        <li>
    <a class="dropdown-item" href="../reference/scalar-udfs.html">
 <span class="dropdown-text">Scalar UDFs</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Connection APIs</li>
        <li>
    <a class="dropdown-item" href="../reference/connection.html">
 <span class="dropdown-text">Top-level connection APIs</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li class="dropdown-header">Configuration</li>
        <li>
    <a class="dropdown-item" href="../reference/ContextAdjustment.html">
 <span class="dropdown-text">ContextAdjustment</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/Interactive.html">
 <span class="dropdown-text">Interactive</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/Options.html">
 <span class="dropdown-text">Options</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/Repr.html">
 <span class="dropdown-text">Repr</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../reference/SQL.html">
 <span class="dropdown-text">SQL</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../posts.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../release_notes.html"> 
<span class="menu-text">Release notes</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-contribute" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Contribute</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-contribute">    
        <li class="dropdown-header">Contribute</li>
        <li>
    <a class="dropdown-item" href="../contribute/01_environment.html">
 <span class="dropdown-text">Setting up a development environment</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../contribute/02_workflow.html">
 <span class="dropdown-text">Contribute to the Ibis codebase</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../contribute/03_style.html">
 <span class="dropdown-text">Style and formatting</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../contribute/04_maintainers_guide.html">
 <span class="dropdown-text">Maintaining the codebase</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../contribute/05_reference.html">
 <span class="dropdown-text">Test Class Reference</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/ibis-project/ibis">
            Source code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/ibis-project/ibis/issues/new?assignees=&amp;labels=bug&amp;projects=&amp;template=bug-report.yml&amp;title=bug">
            Report a bug
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/ibis-project/ibis/issues/new?assignees=&amp;labels=docs&amp;projects=&amp;template=docs-issue.yml&amp;title=docs">
            Report a documentation issue
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/ibis-project/ibis/issues/new?assignees=&amp;labels=feature&amp;projects=&amp;template=feature-request.yml&amp;title=feat">
            Submit a feature request
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/ibis-project/ibis/discussions/new?category=q-a">
            Ask the community for help
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../tutorials/ibis-for-sql-users.html">Tutorial: Ibis for SQL users</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Installation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorial: getting started</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/ibis-for-dplyr-users.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorial: Ibis for dplyr users</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/ibis-for-pandas-users.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorial: Ibis for pandas users</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/ibis-for-sql-users.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Tutorial: Ibis for SQL users</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Data Platforms</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Starburst Galaxy</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/data-platforms/starburst-galaxy/0_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Requirements and setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/data-platforms/starburst-galaxy/1_basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic operations</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link active" data-scroll-target="#prerequisites">Prerequisites</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#projections-selectaddremove-columns" id="toc-projections-selectaddremove-columns" class="nav-link" data-scroll-target="#projections-selectaddremove-columns">Projections: select/add/remove columns</a>
  <ul class="collapse">
  <li><a href="#mutate-add-or-modify-columns-easily" id="toc-mutate-add-or-modify-columns-easily" class="nav-link" data-scroll-target="#mutate-add-or-modify-columns-easily"><code>mutate</code>: Add or modify columns easily</a></li>
  <li><a href="#select-equivalent" id="toc-select-equivalent" class="nav-link" data-scroll-target="#select-equivalent"><code>SELECT *</code> equivalent</a></li>
  <li><a href="#using-functions-in-projections" id="toc-using-functions-in-projections" class="nav-link" data-scroll-target="#using-functions-in-projections">Using functions in projections</a></li>
  </ul></li>
  <li><a href="#filtering-where" id="toc-filtering-where" class="nav-link" data-scroll-target="#filtering-where">Filtering / <code>WHERE</code></a></li>
  <li><a href="#aggregation-group-by" id="toc-aggregation-group-by" class="nav-link" data-scroll-target="#aggregation-group-by">Aggregation / <code>GROUP BY</code></a>
  <ul class="collapse">
  <li><a href="#non-trivial-grouping-keys" id="toc-non-trivial-grouping-keys" class="nav-link" data-scroll-target="#non-trivial-grouping-keys">Non-trivial grouping keys</a></li>
  <li><a href="#aggregates-considering-table-subsets" id="toc-aggregates-considering-table-subsets" class="nav-link" data-scroll-target="#aggregates-considering-table-subsets">Aggregates considering table subsets</a></li>
  <li><a href="#counting-rows-with-table.count" id="toc-counting-rows-with-table.count" class="nav-link" data-scroll-target="#counting-rows-with-table.count">Counting rows with <code>Table.count()</code>:</a></li>
  <li><a href="#frequency-table-convenience-value_counts" id="toc-frequency-table-convenience-value_counts" class="nav-link" data-scroll-target="#frequency-table-convenience-value_counts">Frequency table convenience: <code>value_counts</code></a></li>
  <li><a href="#having-clause" id="toc-having-clause" class="nav-link" data-scroll-target="#having-clause"><code>HAVING</code> clause</a></li>
  </ul></li>
  <li><a href="#sorting-order-by" id="toc-sorting-order-by" class="nav-link" data-scroll-target="#sorting-order-by">Sorting / <code>ORDER BY</code></a></li>
  <li><a href="#limit-and-offset" id="toc-limit-and-offset" class="nav-link" data-scroll-target="#limit-and-offset"><code>LIMIT</code> and <code>OFFSET</code></a></li>
  <li><a href="#common-column-expressions" id="toc-common-column-expressions" class="nav-link" data-scroll-target="#common-column-expressions">Common column expressions</a>
  <ul class="collapse">
  <li><a href="#type-casts" id="toc-type-casts" class="nav-link" data-scroll-target="#type-casts">Type casts</a></li>
  <li><a href="#case-statements" id="toc-case-statements" class="nav-link" data-scroll-target="#case-statements"><code>CASE</code> statements</a></li>
  <li><a href="#using-null-in-expressions" id="toc-using-null-in-expressions" class="nav-link" data-scroll-target="#using-null-in-expressions">Using <code>NULL</code> in expressions</a></li>
  <li><a href="#set-membership-in-not-in" id="toc-set-membership-in-not-in" class="nav-link" data-scroll-target="#set-membership-in-not-in">Set membership: <code>IN</code> / <code>NOT IN</code></a></li>
  <li><a href="#constant-and-literal-expressions" id="toc-constant-and-literal-expressions" class="nav-link" data-scroll-target="#constant-and-literal-expressions">Constant and literal expressions</a></li>
  <li><a href="#is-null-and-is-not-null" id="toc-is-null-and-is-not-null" class="nav-link" data-scroll-target="#is-null-and-is-not-null"><code>IS NULL</code> and <code>IS NOT NULL</code></a></li>
  <li><a href="#between" id="toc-between" class="nav-link" data-scroll-target="#between"><code>BETWEEN</code></a></li>
  </ul></li>
  <li><a href="#joins" id="toc-joins" class="nav-link" data-scroll-target="#joins">Joins</a>
  <ul class="collapse">
  <li><a href="#join-projection" id="toc-join-projection" class="nav-link" data-scroll-target="#join-projection">Join + projection</a></li>
  <li><a href="#join-aggregation" id="toc-join-aggregation" class="nav-link" data-scroll-target="#join-aggregation">Join + aggregation</a></li>
  <li><a href="#join-with-select" id="toc-join-with-select" class="nav-link" data-scroll-target="#join-with-select">Join with <code>SELECT *</code></a></li>
  <li><a href="#multiple-joins" id="toc-multiple-joins" class="nav-link" data-scroll-target="#multiple-joins">Multiple joins</a></li>
  <li><a href="#self-joins" id="toc-self-joins" class="nav-link" data-scroll-target="#self-joins">Self joins</a></li>
  <li><a href="#overlapping-join-keys" id="toc-overlapping-join-keys" class="nav-link" data-scroll-target="#overlapping-join-keys">Overlapping join keys</a></li>
  <li><a href="#non-equality-join-predicates" id="toc-non-equality-join-predicates" class="nav-link" data-scroll-target="#non-equality-join-predicates">Non-equality join predicates</a></li>
  <li><a href="#other-ways-to-specify-join-keys" id="toc-other-ways-to-specify-join-keys" class="nav-link" data-scroll-target="#other-ways-to-specify-join-keys">Other ways to specify join keys</a></li>
  </ul></li>
  <li><a href="#subqueries" id="toc-subqueries" class="nav-link" data-scroll-target="#subqueries">Subqueries</a>
  <ul class="collapse">
  <li><a href="#correlated-exists-not-exists-filters" id="toc-correlated-exists-not-exists-filters" class="nav-link" data-scroll-target="#correlated-exists-not-exists-filters">Correlated <code>EXISTS</code> / <code>NOT EXISTS</code> filters</a></li>
  <li><a href="#subqueries-with-in-not-in" id="toc-subqueries-with-in-not-in" class="nav-link" data-scroll-target="#subqueries-with-in-not-in">Subqueries with <code>IN</code> / <code>NOT IN</code></a></li>
  <li><a href="#comparison-with-scalar-aggregates" id="toc-comparison-with-scalar-aggregates" class="nav-link" data-scroll-target="#comparison-with-scalar-aggregates">Comparison with scalar aggregates</a></li>
  <li><a href="#conditional-aggregates" id="toc-conditional-aggregates" class="nav-link" data-scroll-target="#conditional-aggregates">Conditional aggregates</a></li>
  </ul></li>
  <li><a href="#distinct-expressions" id="toc-distinct-expressions" class="nav-link" data-scroll-target="#distinct-expressions"><code>DISTINCT</code> expressions</a></li>
  <li><a href="#window-functions" id="toc-window-functions" class="nav-link" data-scroll-target="#window-functions">Window functions</a></li>
  <li><a href="#top-k-operations" id="toc-top-k-operations" class="nav-link" data-scroll-target="#top-k-operations">Top-K operations</a></li>
  <li><a href="#date-time-data" id="toc-date-time-data" class="nav-link" data-scroll-target="#date-time-data">Date / time data</a>
  <ul class="collapse">
  <li><a href="#casting-to-date-time-types" id="toc-casting-to-date-time-types" class="nav-link" data-scroll-target="#casting-to-date-time-types">Casting to date / time types</a></li>
  <li><a href="#intervals" id="toc-intervals" class="nav-link" data-scroll-target="#intervals">Intervals</a></li>
  </ul></li>
  <li><a href="#buckets-and-histograms" id="toc-buckets-and-histograms" class="nav-link" data-scroll-target="#buckets-and-histograms">Buckets and histograms</a></li>
  <li><a href="#unions" id="toc-unions" class="nav-link" data-scroll-target="#unions">Unions</a></li>
  <li><a href="#esoterica" id="toc-esoterica" class="nav-link" data-scroll-target="#esoterica">Esoterica</a>
  <ul class="collapse">
  <li><a href="#common-table-expressions-ctes" id="toc-common-table-expressions-ctes" class="nav-link" data-scroll-target="#common-table-expressions-ctes">Common table expressions (CTEs)</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ibis-project/ibis/edit/master/docs/tutorials/ibis-for-sql-users.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/ibis-project/ibis/issues/new/choose" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tutorial: Ibis for SQL users</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>

<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>We recommend starting with the default (DuckDB) backend for a performant, fully-featured local experience. You can install Ibis with <code>pip</code>, <code>conda</code>, <code>mamba</code>, or <code>pixi</code>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Using <code>pip</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Using <code>conda</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Using <code>mamba</code></a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">Using <code>pixi</code></a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="st">'ibis-framework[duckdb]'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that the <code>ibis-framework</code> package is <em>not</em> the same as the <code>ibis</code> package in PyPI. These two libraries cannot coexist in the same Python environment, as they are both imported with the <code>ibis</code> module name.</p>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install <span class="at">-c</span> conda-forge ibis-duckdb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">mamba</span> install <span class="at">-c</span> conda-forge ibis-duckdb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pixi</span> add ibis-duckdb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>Ibis provides a full-featured replacement for SQL <code>SELECT</code> queries, but expressed with Python code that is:</p>
<ul>
<li>Type-checked and validated as you go. No more debugging cryptic database errors; Ibis catches your mistakes right away.</li>
<li>Easier to write. Pythonic function calls with tab completion in IPython.</li>
<li>More composable. Break complex queries down into easier-to-digest pieces</li>
<li>Easier to reuse. Mix and match Ibis snippets to create expressions tailored for your analysis.</li>
</ul>
<p>We intend for all <code>SELECT</code> queries to be fully portable to Ibis. Coverage of other DDL statements (e.g.&nbsp;<code>CREATE TABLE</code> or <code>INSERT</code>) may vary from engine to engine.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you find any SQL idioms or use cases in your work that are not represented here, please reach out so we can add more to this guide!</p>
</div>
</div>
</section>
<section id="projections-selectaddremove-columns" class="level2">
<h2 class="anchored" data-anchor-id="projections-selectaddremove-columns">Projections: select/add/remove columns</h2>
<p>All tables in Ibis are immutable. To select a subset of a table’s columns, or to add new columns, you must produce a new table by means of a <em>projection</em>.</p>
<div id="cf4e55af" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ibis</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> ibis.table(<span class="bu">dict</span>(one<span class="op">=</span><span class="st">"string"</span>, two<span class="op">=</span><span class="st">"float"</span>, three<span class="op">=</span><span class="st">"int32"</span>), name<span class="op">=</span><span class="st">"my_data"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">UnboundTable: my_data
  one   string
  two   float64
  three int32
</pre>
</div>
</div>
<p>In SQL, you might write something like:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> two, one</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In Ibis, this is</p>
<div id="7975973b" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>proj <span class="op">=</span> t[<span class="st">"two"</span>, <span class="st">"one"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>or</p>
<div id="a70bbf14" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>proj <span class="op">=</span> t.select(<span class="st">"two"</span>, <span class="st">"one"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This generates the expected SQL:</p>
<div id="6f5d6277" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(proj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div class="sourceCode" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  t0.one</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>What about adding new columns?</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> two, one, three <span class="op">*</span> <span class="dv">2</span> <span class="kw">AS</span> new_col</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The last expression is written:</p>
<div id="80d5a9d9" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>new_col <span class="op">=</span> (t.three <span class="op">*</span> <span class="dv">2</span>).name(<span class="st">"new_col"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we have:</p>
<div id="a2f23dae" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>proj <span class="op">=</span> t[<span class="st">"two"</span>, <span class="st">"one"</span>, new_col]</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(proj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div class="sourceCode" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  t0.three <span class="op">*</span> <span class="fu">CAST</span>(<span class="dv">2</span> <span class="kw">AS</span> TINYINT) <span class="kw">AS</span> new_col</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<section id="mutate-add-or-modify-columns-easily" class="level3">
<h3 class="anchored" data-anchor-id="mutate-add-or-modify-columns-easily"><code>mutate</code>: Add or modify columns easily</h3>
<p>Since adding new columns or modifying existing columns is so common, there is a convenience method <code>mutate</code>:</p>
<div id="a37c870b" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mutated <span class="op">=</span> t.mutate(new_col<span class="op">=</span>t.three <span class="op">*</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that using the <code>name</code> was not necessary here because we’re using Python keyword arguments to provide the name:</p>
<div id="85ae4bb9" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(mutated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div class="sourceCode" id="cb17"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  t0.three <span class="op">*</span> <span class="fu">CAST</span>(<span class="dv">2</span> <span class="kw">AS</span> TINYINT) <span class="kw">AS</span> new_col</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>If you modify an existing column with <code>mutate</code> it will list out all the other columns:</p>
<div id="8076bdc1" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>mutated <span class="op">=</span> t.mutate(two<span class="op">=</span>t.two <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(mutated)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div class="sourceCode" id="cb19"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">*</span> <span class="fu">CAST</span>(<span class="dv">2</span> <span class="kw">AS</span> TINYINT) <span class="kw">AS</span> two,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  t0.three</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="select-equivalent" class="level3">
<h3 class="anchored" data-anchor-id="select-equivalent"><code>SELECT *</code> equivalent</h3>
<p>Especially in combination with relational joins, it’s convenient to be able to select all columns in a table using the <code>SELECT *</code> construct. To do this, use the table expression itself in a projection:</p>
<div id="44d113de" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>proj <span class="op">=</span> t[t]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(proj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div class="sourceCode" id="cb21"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  t0.three</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>This is how <code>mutate</code> is implemented. The example above <code>t.mutate(new_col=t.three * 2)</code> can be written as a normal projection:</p>
<div id="353a0bbe" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>proj <span class="op">=</span> t[t, new_col]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(proj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div class="sourceCode" id="cb23"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  t0.three <span class="op">*</span> <span class="fu">CAST</span>(<span class="dv">2</span> <span class="kw">AS</span> TINYINT) <span class="kw">AS</span> new_col</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Let’s consider a table we might wish to join with <code>t</code>:</p>
<div id="a8971286" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>t2 <span class="op">=</span> ibis.table(<span class="bu">dict</span>(key<span class="op">=</span><span class="st">"string"</span>, value<span class="op">=</span><span class="st">"float"</span>), name<span class="op">=</span><span class="st">"dim_table"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s take the SQL:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t0.<span class="op">*</span>, t0.two <span class="op">-</span> t1.<span class="fu">value</span> <span class="kw">AS</span> diff</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data t0</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INNER</span> <span class="kw">JOIN</span> dim_table t1</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> t0.one <span class="op">=</span> t1.<span class="kw">key</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To write this with Ibis, it is:</p>
<div id="212008a6" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>diff <span class="op">=</span> (t.two <span class="op">-</span> t2.value).name(<span class="st">"diff"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> t.join(t2, t.one <span class="op">==</span> t2.key)[t, diff]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And verify the generated SQL:</p>
<div id="858e3dd8" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(joined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div class="sourceCode" id="cb28"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">-</span> t1.<span class="fu">value</span> <span class="kw">AS</span> diff</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> dim_table <span class="kw">AS</span> t1</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.one <span class="op">=</span> t1.<span class="kw">key</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="using-functions-in-projections" class="level3">
<h3 class="anchored" data-anchor-id="using-functions-in-projections">Using functions in projections</h3>
<p>If you pass a function instead of a string or Ibis expression in any projection context, it will be invoked with the “parent” table as its argument. This can help significantly when [composing complex operations. Consider this SQL:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> one, <span class="fu">avg</span>(<span class="fu">abs</span>(the_sum)) <span class="kw">AS</span> mad</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> one, three, <span class="fu">sum</span>(two) <span class="kw">AS</span> the_sum</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> my_data</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>) t0</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This can be written as one chained expression:</p>
<div id="f98ba7e5" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> (</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    t.group_by([<span class="st">"one"</span>, <span class="st">"three"</span>])</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    .aggregate(the_sum<span class="op">=</span>t.two.<span class="bu">sum</span>())</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    .group_by(<span class="st">"one"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    .aggregate(mad<span class="op">=</span><span class="kw">lambda</span> x: x.the_sum.<span class="bu">abs</span>().mean())</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the SQL:</p>
<div id="64cbf699" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div class="sourceCode" id="cb32"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(<span class="fu">ABS</span>(t0.the_sum)) <span class="kw">AS</span> mad</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    t1.one <span class="kw">AS</span> one,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    t1.three <span class="kw">AS</span> three,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SUM</span>(t1.two) <span class="kw">AS</span> the_sum</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> my_data <span class="kw">AS</span> t1</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> t0</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="filtering-where" class="level2">
<h2 class="anchored" data-anchor-id="filtering-where">Filtering / <code>WHERE</code></h2>
<p>You can add filter clauses to a table expression either by indexing with <code>[]</code> (similar to pandas) or use the <code>filter</code> method:</p>
<div id="0dbb770b" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>filtered <span class="op">=</span> t[t.two <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div class="sourceCode" id="cb34"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  t0.three</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">&gt;</span> <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p><code>filter</code> can take a list of expressions, which must all be satisfied for a row to appear in the result:</p>
<div id="b4be8af4" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>filtered <span class="op">=</span> t.<span class="bu">filter</span>([t.two <span class="op">&gt;</span> <span class="dv">0</span>, t.one.isin([<span class="st">"A"</span>, <span class="st">"B"</span>])])</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div class="sourceCode" id="cb36"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  t0.three</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">&gt;</span> <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="kw">AND</span> t0.one <span class="kw">IN</span> (<span class="st">'A'</span>, <span class="st">'B'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>To compose boolean expressions with <code>AND</code> or <code>OR</code>, use the respective <code>&amp;</code> and <code>|</code> operators:</p>
<div id="6e67a9ab" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>cond <span class="op">=</span> (t.two <span class="op">&lt;</span> <span class="dv">0</span>) <span class="op">|</span> ((t.two <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">|</span> t.one.isin([<span class="st">"A"</span>, <span class="st">"B"</span>]))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>filtered <span class="op">=</span> t[cond]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(filtered)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div class="sourceCode" id="cb38"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  t0.three</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">&lt;</span> <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="kw">OR</span> t0.two <span class="op">&gt;</span> <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="kw">OR</span> t0.one <span class="kw">IN</span> (<span class="st">'A'</span>, <span class="st">'B'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Note the parentheses around the second expression. These are necessary due to operator precedence.</p>
</section>
<section id="aggregation-group-by" class="level2">
<h2 class="anchored" data-anchor-id="aggregation-group-by">Aggregation / <code>GROUP BY</code></h2>
<p>To aggregate a table, you need:</p>
<ul>
<li>Zero or more grouping expressions (these can be column names)</li>
<li>One or more aggregation expressions</li>
</ul>
<p>Let’s look at the <code>aggregate</code> method on tables:</p>
<div id="d9be6386" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>agged <span class="op">=</span> t.aggregate(total_two<span class="op">=</span>t.two.<span class="bu">sum</span>(), avg_three<span class="op">=</span>t.three.mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you don’t use any group expressions, the result will have a single row with your statistics of interest:</p>
<div id="a1519f77" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>agged.schema()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>ibis.Schema {
  total_two  float64
  avg_three  float64
}</code></pre>
</div>
</div>
<div id="4f70f1a4" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(agged)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div class="sourceCode" id="cb43"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(t0.two) <span class="kw">AS</span> total_two,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(t0.three) <span class="kw">AS</span> avg_three</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>To add groupings, use either the <code>by</code> argument of <code>aggregate</code> or use the <code>group_by</code> construct:</p>
<div id="dfdccc93" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>agged2 <span class="op">=</span> t.aggregate(total_two<span class="op">=</span>t.two.<span class="bu">sum</span>(), avg_three<span class="op">=</span>t.three.mean())</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>agged3 <span class="op">=</span> t.group_by(<span class="st">"one"</span>).aggregate(total_two<span class="op">=</span>t.two.<span class="bu">sum</span>(), avg_three<span class="op">=</span>t.three.mean())</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(agged3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div class="sourceCode" id="cb45"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(t0.two) <span class="kw">AS</span> total_two,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(t0.three) <span class="kw">AS</span> avg_three</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<section id="non-trivial-grouping-keys" class="level3">
<h3 class="anchored" data-anchor-id="non-trivial-grouping-keys">Non-trivial grouping keys</h3>
<p>You can use any expression (or function, like in projections) deriving from the table you are aggregating. The only constraint is that the expressions must be named. Let’s look at an example:</p>
<div id="ca04c981" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>events <span class="op">=</span> ibis.table(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(ts<span class="op">=</span><span class="st">"timestamp"</span>, event_type<span class="op">=</span><span class="st">"int32"</span>, session_id<span class="op">=</span><span class="st">"int64"</span>),</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"web_events"</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Suppose we wanted to total up event types by year and month:</p>
<div id="3c16793f" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>stats <span class="op">=</span> (</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    events.group_by(year<span class="op">=</span>events.ts.year(), month<span class="op">=</span>events.ts.month())</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    .aggregate(total<span class="op">=</span>events.count(), sessions<span class="op">=</span>events.session_id.nunique())</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have:</p>
<div id="d93e0e0a" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(stats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<div class="sourceCode" id="cb49"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">year</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">month</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">AS</span> <span class="dt">month</span>,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> total,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> t0.session_id) <span class="kw">AS</span> sessions</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> web_events <span class="kw">AS</span> t0</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="aggregates-considering-table-subsets" class="level3">
<h3 class="anchored" data-anchor-id="aggregates-considering-table-subsets">Aggregates considering table subsets</h3>
<p>In analytics is it common to compare statistics from different subsets of a table. Let’s consider a dataset containing people’s name, age, gender, and nationality:</p>
<div id="bb6e71e9" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>pop <span class="op">=</span> ibis.table(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(name<span class="op">=</span><span class="st">"string"</span>, country<span class="op">=</span><span class="st">"string"</span>, gender<span class="op">=</span><span class="st">"string"</span>, age<span class="op">=</span><span class="st">"int16"</span>),</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"population"</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, suppose you wanted to know for each country:</p>
<ul>
<li>Average overall age</li>
<li>Average male age</li>
<li>Average female age</li>
<li>Total number of persons</li>
</ul>
<p>In SQL, you may write:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  country,</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> num_persons,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(age) <span class="kw">AS</span> avg_age</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> <span class="cf">WHEN</span> gender <span class="op">=</span> <span class="st">'M'</span> <span class="cf">THEN</span> age</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="kw">NULL</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">AS</span> avg_male,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> <span class="cf">WHEN</span> gender <span class="op">=</span> <span class="st">'F'</span> <span class="cf">THEN</span> age</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="kw">NULL</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">AS</span> avg_female,</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> population</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ibis makes this much simpler by giving you <code>where</code> option in aggregation functions:</p>
<div id="0ea239dd" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> pop.group_by(<span class="st">"country"</span>).aggregate(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    num_persons<span class="op">=</span>pop.count(),</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    avg_age<span class="op">=</span>pop.age.mean(),</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    avg_male<span class="op">=</span>pop.age.mean(where<span class="op">=</span>pop.gender <span class="op">==</span> <span class="st">"M"</span>),</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    avg_female<span class="op">=</span>pop.age.mean(where<span class="op">=</span>pop.gender <span class="op">==</span> <span class="st">"F"</span>),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This indeed generates the correct SQL. Note that SQL engines handle <code>NULL</code> values differently in aggregation functions, but Ibis will write the SQL expression that is correct for your query engine.</p>
<div id="f1921bab" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div class="sourceCode" id="cb54"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  t0.country,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> num_persons,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(t0.age) <span class="kw">AS</span> avg_age,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(t0.age) <span class="kw">FILTER</span>(<span class="kw">WHERE</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    t0.gender <span class="op">=</span> <span class="st">'M'</span>) <span class="kw">AS</span> avg_male,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(t0.age) <span class="kw">FILTER</span>(<span class="kw">WHERE</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    t0.gender <span class="op">=</span> <span class="st">'F'</span>) <span class="kw">AS</span> avg_female</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> population <span class="kw">AS</span> t0</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="counting-rows-with-table.count" class="level3">
<h3 class="anchored" data-anchor-id="counting-rows-with-table.count">Counting rows with <a href="../reference/expression-tables.html#ibis.expr.types.relations.Table.count"><code>Table.count()</code></a>:</h3>
<p>Computing group frequencies can be done by calling <code>count()</code> after calling <code>group_by()</code>:</p>
<div id="b74f998a" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>freqs <span class="op">=</span> events.group_by(year<span class="op">=</span>events.ts.year(), month<span class="op">=</span>events.ts.month()).count()</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(freqs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div class="sourceCode" id="cb56"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">year</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">month</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">AS</span> <span class="dt">month</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> <span class="ot">"CountStar(web_events)"</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> web_events <span class="kw">AS</span> t0</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>,</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="frequency-table-convenience-value_counts" class="level3">
<h3 class="anchored" data-anchor-id="frequency-table-convenience-value_counts">Frequency table convenience: <code>value_counts</code></h3>
<p>Consider the SQL idiom:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> some_column_expression, <span class="fu">count</span>(<span class="op">*</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">table</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is so common that, like pandas, there is a generic column method <code>value_counts</code> which does this:</p>
<div id="391394dd" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> events.ts.year().value_counts()</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div class="sourceCode" id="cb59"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  t0.<span class="ot">"ExtractYear(ts)"</span>,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> <span class="ot">"ExtractYear(ts)_count"</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">year</span> <span class="kw">FROM</span> t1.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">AS</span> <span class="ot">"ExtractYear(ts)"</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> web_events <span class="kw">AS</span> t1</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> t0</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="having-clause" class="level3">
<h3 class="anchored" data-anchor-id="having-clause"><code>HAVING</code> clause</h3>
<p>The SQL <code>HAVING</code> clause enables you to filter the results of an aggregation based on some group-wise condition holding true. For example, suppose we wanted to limit our analysis to groups containing at least 1000 observations:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> one, <span class="fu">sum</span>(two) <span class="kw">AS</span> total</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="kw">HAVING</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="op">&gt;=</span> <span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With Ibis, you can do:</p>
<div id="765d018e" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> (</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    t.group_by(<span class="st">"one"</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    .having(t.count() <span class="op">&gt;=</span> <span class="dv">1000</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    .aggregate(total<span class="op">=</span>t.two.<span class="bu">sum</span>())</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div class="sourceCode" id="cb62"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(t0.two) <span class="kw">AS</span> total</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="kw">HAVING</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="op">&gt;=</span> <span class="fu">CAST</span>(<span class="dv">1000</span> <span class="kw">AS</span> <span class="dt">SMALLINT</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="sorting-order-by" class="level2">
<h2 class="anchored" data-anchor-id="sorting-order-by">Sorting / <code>ORDER BY</code></h2>
<p>To sort a table, use the <code>order_by</code> method along with either column names or expressions that indicate the sorting keys:</p>
<div id="838db424" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sorted</span> <span class="op">=</span> events.order_by([events.ts.year(), events.ts.month()])</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(<span class="bu">sorted</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div class="sourceCode" id="cb64"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  t0.ts,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  t0.event_type,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  t0.session_id</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> web_events <span class="kw">AS</span> t0</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">year</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">ASC</span>,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">month</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">ASC</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The default for sorting is in ascending order. To reverse the sort direction of any key, wrap it in <code>ibis.desc</code>:</p>
<div id="6e6c915e" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="bu">sorted</span> <span class="op">=</span> (</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    events.order_by([ibis.desc(<span class="st">"event_type"</span>), ibis.desc(events.ts.month())])</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    .limit(<span class="dv">100</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(<span class="bu">sorted</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div class="sourceCode" id="cb66"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  t0.ts,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  t0.event_type,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  t0.session_id</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> web_events <span class="kw">AS</span> t0</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  t0.event_type <span class="kw">DESC</span>,</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">month</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">DESC</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="limit-and-offset" class="level2">
<h2 class="anchored" data-anchor-id="limit-and-offset"><code>LIMIT</code> and <code>OFFSET</code></h2>
<p>The table <code>limit</code> function truncates a table to the indicates number of rows. So if you only want the first 1000 rows (which may not be deterministic depending on the SQL engine), you can do:</p>
<div id="b795f713" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>limited <span class="op">=</span> t.limit(<span class="dv">1000</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(limited)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div class="sourceCode" id="cb68"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  t0.three</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">1000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The <code>offset</code> option in <code>limit</code> skips rows. So if you wanted rows 11 through 20, you could do:</p>
<div id="5591984f" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>limited <span class="op">=</span> t.limit(<span class="dv">10</span>, offset<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(limited)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div class="sourceCode" id="cb70"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  t0.three</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>OFFSET <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="common-column-expressions" class="level2">
<h2 class="anchored" data-anchor-id="common-column-expressions">Common column expressions</h2>
<p>See the full <a href="../reference/expression-generic.html">API documentation</a> for all of the available value methods and tools for creating value expressions.</p>
<p>We mention a few common ones here as they relate to common SQL queries.</p>
<section id="type-casts" class="level3">
<h3 class="anchored" data-anchor-id="type-casts">Type casts</h3>
<p>Ibis’s type system is independent of any SQL system. You cast Ibis expressions from one Ibis type to another. For example:</p>
<div id="8830582c" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.mutate(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    date<span class="op">=</span>t.one.cast(<span class="st">"timestamp"</span>),</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    four<span class="op">=</span>t.three.cast(<span class="st">"float32"</span>),</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<div class="sourceCode" id="cb72"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(t0.one <span class="kw">AS</span> <span class="dt">TIMESTAMP</span>) <span class="kw">AS</span> <span class="dt">date</span>,</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(t0.three <span class="kw">AS</span> <span class="dt">REAL</span>) <span class="kw">AS</span> four</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="case-statements" class="level3">
<h3 class="anchored" data-anchor-id="case-statements"><code>CASE</code> statements</h3>
<p>SQL dialects typically support one or more kind of <code>CASE</code> statements. The first is the <em>simple case</em> that compares against exact values of an expression.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span> expr</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> value_1 <span class="cf">THEN</span> result_1</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> value_2 <span class="cf">THEN</span> result_2</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span> <span class="kw">default</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Value expressions in Ibis have a <code>case</code> method that allows us to emulate these semantics:</p>
<div id="2b4f7ec5" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>case <span class="op">=</span> (</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    t.one.cast(<span class="st">"timestamp"</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    .year()</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    .case()</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    .when(<span class="dv">2015</span>, <span class="st">"This year"</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    .when(<span class="dv">2014</span>, <span class="st">"Last year"</span>)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    .else_(<span class="st">"Earlier"</span>)</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    .end()</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.mutate(year_group<span class="op">=</span>case)</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div class="sourceCode" id="cb75"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">year</span> <span class="kw">FROM</span> <span class="fu">CAST</span>(t0.one <span class="kw">AS</span> <span class="dt">TIMESTAMP</span>)) <span class="kw">AS</span> <span class="dt">SMALLINT</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="fu">CAST</span>(<span class="dv">2015</span> <span class="kw">AS</span> <span class="dt">SMALLINT</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">THEN</span> <span class="st">'This year'</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> <span class="fu">CAST</span>(<span class="dv">2014</span> <span class="kw">AS</span> <span class="dt">SMALLINT</span>)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">THEN</span> <span class="st">'Last year'</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="st">'Earlier'</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> year_group</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The more general case is that of an arbitrary list of boolean expressions and result values:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> boolean_expr1 <span class="cf">THEN</span> result_1</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> boolean_expr2 <span class="cf">THEN</span> result_2</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> boolean_expr3 <span class="cf">THEN</span> result_3</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span> <span class="kw">default</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To do this, use <code>ibis.case</code>:</p>
<div id="1b72be74" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>case <span class="op">=</span> (</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    ibis.case()</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    .when(t.two <span class="op">&lt;</span> <span class="dv">0</span>, t.three <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    .when(t.two <span class="op">&gt;</span> <span class="dv">1</span>, t.three)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    .else_(t.two)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    .end()</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.mutate(cond_value<span class="op">=</span>case)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div class="sourceCode" id="cb78"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> (</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>      t0.two <span class="op">&lt;</span> <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">THEN</span> t0.three <span class="op">*</span> <span class="fu">CAST</span>(<span class="dv">2</span> <span class="kw">AS</span> TINYINT)</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> (</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>      t0.two <span class="op">&gt;</span> <span class="fu">CAST</span>(<span class="dv">1</span> <span class="kw">AS</span> TINYINT)</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">THEN</span> t0.three</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> t0.two</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> cond_value</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>There are several places where Ibis builds cases for you in a simplified way. One example is the <code>ifelse</code> function:</p>
<div id="e18bc3cd" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>switch <span class="op">=</span> (t.two <span class="op">&lt;</span> <span class="dv">0</span>).ifelse(<span class="st">"Negative"</span>, <span class="st">"Non-Negative"</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.mutate(group<span class="op">=</span>switch)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div class="sourceCode" id="cb80"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> <span class="cf">WHEN</span> (</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    t0.two <span class="op">&lt;</span> <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="cf">THEN</span> <span class="st">'Negative'</span> <span class="cf">ELSE</span> <span class="st">'Non-Negative'</span> <span class="cf">END</span> <span class="kw">AS</span> <span class="ot">"group"</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="using-null-in-expressions" class="level3">
<h3 class="anchored" data-anchor-id="using-null-in-expressions">Using <code>NULL</code> in expressions</h3>
<p>To use <code>NULL</code> in an expression, either use the special <code>ibis.NA</code> value:</p>
<div id="213225a8" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>pos_two <span class="op">=</span> (t.two <span class="op">&gt;</span> <span class="dv">0</span>).ifelse(t.two, ibis.NA)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.mutate(two_positive<span class="op">=</span>pos_two)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<div class="sourceCode" id="cb82"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> <span class="cf">WHEN</span> (</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    t0.two <span class="op">&gt;</span> <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="cf">THEN</span> t0.two <span class="cf">ELSE</span> <span class="kw">NULL</span> <span class="cf">END</span> <span class="kw">AS</span> two_positive</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="set-membership-in-not-in" class="level3">
<h3 class="anchored" data-anchor-id="set-membership-in-not-in">Set membership: <code>IN</code> / <code>NOT IN</code></h3>
<p>Let’s look again at the population dataset. Suppose you wanted to combine the United States and Canada data into a “North America” category. Here would be some SQL to do it:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="cf">CASE</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">WHEN</span> <span class="fu">UPPER</span>(country) <span class="kw">IN</span> (<span class="st">'UNITED STATES'</span>, <span class="st">'CANADA'</span>) <span class="cf">THEN</span> <span class="st">'North America'</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">ELSE</span> country</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span> <span class="kw">AS</span> refined_group</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The Ibis equivalent of <code>IN</code> is the <code>isin</code> method. So we can write:</p>
<div id="8b94429e" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>refined <span class="op">=</span> (</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    pop.country.upper()</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    .isin([<span class="st">"UNITED STATES"</span>, <span class="st">"CANADA"</span>])</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    .ifelse(<span class="st">"North America"</span>, pop.country)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> pop.mutate(refined_group<span class="op">=</span>refined)</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<div class="sourceCode" id="cb85"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  t0.name,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  t0.country,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  t0.gender,</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  t0.age,</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> (</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">UPPER</span>(t0.country) <span class="kw">IN</span> (<span class="st">'UNITED STATES'</span>, <span class="st">'CANADA'</span>)</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">THEN</span> <span class="st">'North America'</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> t0.country</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> refined_group</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> population <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The opposite of <code>isin</code> is <code>notin</code>.</p>
</section>
<section id="constant-and-literal-expressions" class="level3">
<h3 class="anchored" data-anchor-id="constant-and-literal-expressions">Constant and literal expressions</h3>
<p>Consider a SQL expression like:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="st">'foo'</span> <span class="kw">IN</span> (column1, column2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>which is equivalent to</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>column1 <span class="op">=</span> <span class="st">'foo'</span> <span class="kw">OR</span> column2 <span class="op">=</span> <span class="st">'foo'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To build expressions off constant values, you must first convert the value (whether a Python string or number) to an Ibis expression using <code>ibis.literal</code>:</p>
<div id="af20b03a" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>t3 <span class="op">=</span> ibis.table(</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(column1<span class="op">=</span><span class="st">"string"</span>, column2<span class="op">=</span><span class="st">"string"</span>, column3<span class="op">=</span><span class="st">"float"</span>),</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"data"</span>,</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>value <span class="op">=</span> ibis.literal(<span class="st">"foo"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once you’ve done this, you can use the literal expression like any other array or scalar expression:</p>
<div id="7749c215" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>has_foo <span class="op">=</span> value.isin([t3.column1, t3.column2])</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t3.mutate(has_foo<span class="op">=</span>has_foo)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div class="sourceCode" id="cb90"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  t0.column1,</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  t0.column2,</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  t0.column3,</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'foo'</span> <span class="kw">IN</span> (t0.column1, t0.column2) <span class="kw">AS</span> has_foo</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">data</span> <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>In many other situations, you can use constants without having to use <code>ibis.literal</code>. For example, we could add a column containing nothing but the number 5 like so:</p>
<div id="14365494" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t3.mutate(number5<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div class="sourceCode" id="cb92"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  t0.column1,</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  t0.column2,</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  t0.column3,</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="dv">5</span> <span class="kw">AS</span> TINYINT) <span class="kw">AS</span> number5</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">data</span> <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="is-null-and-is-not-null" class="level3">
<h3 class="anchored" data-anchor-id="is-null-and-is-not-null"><code>IS NULL</code> and <code>IS NOT NULL</code></h3>
<p>These are simple: use the <code>isnull</code> and <code>notnull</code> functions respectively, which yield boolean arrays:</p>
<div id="7eec4cbd" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>indic <span class="op">=</span> t.two.isnull().ifelse(<span class="st">"valid"</span>, <span class="st">"invalid"</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.mutate(is_valid<span class="op">=</span>indic)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div class="sourceCode" id="cb94"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> <span class="cf">WHEN</span> (</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    t0.two <span class="kw">IS</span> <span class="kw">NULL</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="cf">THEN</span> <span class="st">'valid'</span> <span class="cf">ELSE</span> <span class="st">'invalid'</span> <span class="cf">END</span> <span class="kw">AS</span> is_valid</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="94405ecb" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>agged <span class="op">=</span> (</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    expr[expr.one.notnull()]</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    .group_by(<span class="st">"is_valid"</span>)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    .aggregate(three_count<span class="op">=</span><span class="kw">lambda</span> t: t.three.notnull().<span class="bu">sum</span>())</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(agged)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<div class="sourceCode" id="cb96"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  t0.is_valid,</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(<span class="fu">CAST</span>(<span class="kw">NOT</span> t0.three <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">AS</span> <span class="dt">INT</span>)) <span class="kw">AS</span> three_count</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    t1.one <span class="kw">AS</span> one,</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    t1.two <span class="kw">AS</span> two,</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    t1.three <span class="kw">AS</span> three,</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">CASE</span> <span class="cf">WHEN</span> (</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>      t1.two <span class="kw">IS</span> <span class="kw">NULL</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="cf">THEN</span> <span class="st">'valid'</span> <span class="cf">ELSE</span> <span class="st">'invalid'</span> <span class="cf">END</span> <span class="kw">AS</span> is_valid</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> my_data <span class="kw">AS</span> t1</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">NOT</span> t1.one <span class="kw">IS</span> <span class="kw">NULL</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> t0</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="between" class="level3">
<h3 class="anchored" data-anchor-id="between"><code>BETWEEN</code></h3>
<p>The <code>between</code> method on arrays and scalars compiles to the SQL <code>BETWEEN</code> keyword. The result of <code>between</code> is boolean and can be used with any other boolean expression:</p>
<div id="8fad9ffa" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t[t.two.between(<span class="dv">10</span>, <span class="dv">50</span>) <span class="op">&amp;</span> t.one.notnull()]</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div class="sourceCode" id="cb98"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  t0.three</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="kw">BETWEEN</span> <span class="fu">CAST</span>(<span class="dv">10</span> <span class="kw">AS</span> TINYINT) <span class="kw">AND</span> <span class="fu">CAST</span>(<span class="dv">50</span> <span class="kw">AS</span> TINYINT) <span class="kw">AND</span> <span class="kw">NOT</span> t0.one <span class="kw">IS</span> <span class="kw">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="joins" class="level2">
<h2 class="anchored" data-anchor-id="joins">Joins</h2>
<p>Ibis supports several kinds of joins between table expressions:</p>
<ul>
<li><code>inner_join</code>: maps to SQL <code>INNER JOIN</code></li>
<li><code>cross_join</code>: a cartesian product join with no keys. Equivalent to <code>inner_join</code> with no join predicates</li>
<li><code>left_join</code>: maps to SQL <code>LEFT OUTER JOIN</code></li>
<li><code>outer_join</code>: maps to SQL <code>FULL OUTER JOIN</code></li>
<li><code>semi_join</code>: maps to SQL <code>LEFT SEMI JOIN</code>. May or may not be an explicit join type in your query engine.</li>
<li><code>anti_join</code>: maps to SQL <code>LEFT ANTI JOIN</code>. May or may not be an explicit join type in your query engine.</li>
</ul>
<p>The <code>join</code> table method is by default the same as <code>inner_join</code>.</p>
<p>Let’s look at a couple example tables to see how joins work in Ibis:</p>
<div id="15e5dc4c" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> ibis.table(<span class="bu">dict</span>(value1<span class="op">=</span><span class="st">"float"</span>, key1<span class="op">=</span><span class="st">"string"</span>, key2<span class="op">=</span><span class="st">"string"</span>), name<span class="op">=</span><span class="st">"table1"</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>t2 <span class="op">=</span> ibis.table(<span class="bu">dict</span>(value2<span class="op">=</span><span class="st">"float"</span>, key3<span class="op">=</span><span class="st">"string"</span>, key4<span class="op">=</span><span class="st">"string"</span>), name<span class="op">=</span><span class="st">"table2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s join on one key:</p>
<div id="ea39d004" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> t1.left_join(t2, t1.key1 <span class="op">==</span> t2.key3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The immediate result of a join does not yet have a set schema. That is determined by the next action that you take. There’s several ways forward from here that address a variety of SQL use cases.</p>
<section id="join-projection" class="level3">
<h3 class="anchored" data-anchor-id="join-projection">Join + projection</h3>
<p>Consider the SQL:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t0.<span class="op">*</span>, t1.value2</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 t0</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> table2 t1</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After one or more joins, you can reference any of the joined tables in a projection immediately after:</p>
<div id="741fe611" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> joined[t1, t2.value2]</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<div class="sourceCode" id="cb103"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  t0.value1,</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  t0.key2,</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  t1.value2</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> table2 <span class="kw">AS</span> t1</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>If you need to compute an expression that involves both tables, you can do that also:</p>
<div id="555ddb20" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> joined[t1.key1, (t1.value1 <span class="op">-</span> t2.value2).name(<span class="st">"diff"</span>)]</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<div class="sourceCode" id="cb105"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  t0.value1 <span class="op">-</span> t1.value2 <span class="kw">AS</span> diff</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> table2 <span class="kw">AS</span> t1</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="join-aggregation" class="level3">
<h3 class="anchored" data-anchor-id="join-aggregation">Join + aggregation</h3>
<p>You can directly aggregate a join without need for projection, which also allows you to form statistics that reference any of the joined tables.</p>
<p>Consider this SQL:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t0.key1, <span class="fu">AVG</span>(t0.value1 <span class="op">-</span> t1.value2) <span class="kw">AS</span> avg_diff</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 t0</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> table2 t1</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key3</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As you would hope, the code is as follows:</p>
<div id="d6bc4328" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>avg_diff <span class="op">=</span> (t1.value1 <span class="op">-</span> t2.value2).mean()</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> (</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    t1.left_join(t2, t1.key1 <span class="op">==</span> t2.key3)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    .group_by(t1.key1)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    .aggregate(avg_diff<span class="op">=</span>avg_diff)</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<div class="sourceCode" id="cb108"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(t0.value1 <span class="op">-</span> t1.value2) <span class="kw">AS</span> avg_diff</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> table2 <span class="kw">AS</span> t1</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key3</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="join-with-select" class="level3">
<h3 class="anchored" data-anchor-id="join-with-select">Join with <code>SELECT *</code></h3>
<p>If you try to compile or execute a join that has not been projected or aggregated, it will be <em>fully materialized</em>:</p>
<div id="47bad629" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> t1.left_join(t2, t1.key1 <span class="op">==</span> t2.key3)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(joined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<div class="sourceCode" id="cb110"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  t0.value1,</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  t0.key2,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  t1.value2,</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  t1.key3,</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  t1.key4</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> table2 <span class="kw">AS</span> t1</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="multiple-joins" class="level3">
<h3 class="anchored" data-anchor-id="multiple-joins">Multiple joins</h3>
<p>You can join multiple tables together in succession without needing to address any of the above concerns.</p>
<div id="921d589d" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>t3 <span class="op">=</span> ibis.table(<span class="bu">dict</span>(value3<span class="op">=</span><span class="st">"float"</span>, key5<span class="op">=</span><span class="st">"string"</span>), name<span class="op">=</span><span class="st">"table3"</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> (t1.value1 <span class="op">+</span> t2.value2 <span class="op">+</span> t3.value3).<span class="bu">sum</span>()</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> (</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    t1.join(t2, [t1.key1 <span class="op">==</span> t2.key3, t1.key2 <span class="op">==</span> t2.key4])</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    .join(t3, t1.key1 <span class="op">==</span> t3.key5)</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    .group_by([t2.key4, t3.key5])</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    .aggregate(total<span class="op">=</span>total)</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<div class="sourceCode" id="cb112"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  t1.key4,</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  t2.key5,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">SUM</span>(t0.value1 <span class="op">+</span> t1.value2 <span class="op">+</span> t2.value3) <span class="kw">AS</span> total</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> table2 <span class="kw">AS</span> t1</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key3 <span class="kw">AND</span> t0.key2 <span class="op">=</span> t1.key4</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> table3 <span class="kw">AS</span> t2</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.key1 <span class="op">=</span> t2.key5</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>,</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="self-joins" class="level3">
<h3 class="anchored" data-anchor-id="self-joins">Self joins</h3>
<p>What about when you need to join a table on itself? For example:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t0.one, <span class="fu">avg</span>(t0.two <span class="op">-</span> t1.three) <span class="kw">AS</span> metric</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data t0</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INNER</span> <span class="kw">JOIN</span> my_data t1</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> t0.one <span class="op">=</span> t1.one</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The table <code>view</code> method enables you to form a <em>self-reference</em> that is referentially distinct in expressions. Now you can proceed normally:</p>
<div id="c0baa650" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>t_view <span class="op">=</span> t.view()</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>stat <span class="op">=</span> (t.two <span class="op">-</span> t_view.three).mean()</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> (</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    t.join(t_view, t.three.cast(<span class="st">"string"</span>) <span class="op">==</span> t_view.one)</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    .group_by(t.one)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>    .aggregate(metric<span class="op">=</span>stat)</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<div class="sourceCode" id="cb115"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">AVG</span>(t1.two <span class="op">-</span> t1.three) <span class="kw">AS</span> metric</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>    t1.one <span class="kw">AS</span> one,</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    t1.two <span class="kw">AS</span> two,</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    t1.three <span class="kw">AS</span> three,</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    t2.one <span class="kw">AS</span> one_right,</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>    t2.two <span class="kw">AS</span> two_right,</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>    t2.three <span class="kw">AS</span> three_right</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> my_data <span class="kw">AS</span> t1</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">JOIN</span> my_data <span class="kw">AS</span> t2</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> <span class="fu">CAST</span>(t1.three <span class="kw">AS</span> TEXT) <span class="op">=</span> t2.one</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> t0, my_data <span class="kw">AS</span> t1, my_data <span class="kw">AS</span> t1</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="overlapping-join-keys" class="level3">
<h3 class="anchored" data-anchor-id="overlapping-join-keys">Overlapping join keys</h3>
<p>In many cases the columns being joined between two tables or table expressions have the same name. Consider this example:</p>
<div id="f87f94c3" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>t4 <span class="op">=</span> ibis.table(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(key1<span class="op">=</span><span class="st">"string"</span>, key2<span class="op">=</span><span class="st">"string"</span>, key3<span class="op">=</span><span class="st">"string"</span>, value1<span class="op">=</span><span class="st">"float"</span>),</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"table4"</span>,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>t5 <span class="op">=</span> ibis.table(</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(key1<span class="op">=</span><span class="st">"string"</span>, key2<span class="op">=</span><span class="st">"string"</span>, key3<span class="op">=</span><span class="st">"string"</span>, value2<span class="op">=</span><span class="st">"float"</span>),</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"table5"</span>,</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In these case, we can specify a list of common join keys:</p>
<div id="ee236a51" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> t4.join(t5, [<span class="st">"key1"</span>, <span class="st">"key2"</span>, <span class="st">"key3"</span>])</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> joined[t4, t5.value2]</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<div class="sourceCode" id="cb118"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  t0.key2,</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  t0.key3,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  t0.value1,</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  t1.value2</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table4 <span class="kw">AS</span> t0</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> table5 <span class="kw">AS</span> t1</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key1 <span class="kw">AND</span> t0.key2 <span class="op">=</span> t1.key2 <span class="kw">AND</span> t0.key3 <span class="op">=</span> t1.key3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>You can mix the overlapping key names with other expressions:</p>
<div id="4091bc3d" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> t4.join(t5, [<span class="st">"key1"</span>, <span class="st">"key2"</span>, t4.key3.left(<span class="dv">4</span>) <span class="op">==</span> t4.key3.left(<span class="dv">4</span>)])</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> joined[t4, t5.value2]</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<div class="sourceCode" id="cb120"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  t0.key2,</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  t0.key3,</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  t0.value1,</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  t1.value2</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table4 <span class="kw">AS</span> t0</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> table5 <span class="kw">AS</span> t1</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.key1 <span class="op">=</span> t1.key1</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> t0.key2 <span class="op">=</span> t1.key2</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> <span class="cf">CASE</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> (</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="op">+</span> <span class="dv">1</span> <span class="op">&gt;=</span> <span class="dv">1</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">THEN</span> <span class="fu">SUBSTR</span>(t0.key3, <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="op">+</span> <span class="dv">1</span>, <span class="fu">CAST</span>(<span class="dv">4</span> <span class="kw">AS</span> TINYINT))</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="fu">SUBSTR</span>(t0.key3, <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> <span class="fu">LENGTH</span>(t0.key3), <span class="fu">CAST</span>(<span class="dv">4</span> <span class="kw">AS</span> TINYINT))</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="op">=</span> <span class="cf">CASE</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHEN</span> (</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="op">+</span> <span class="dv">1</span> <span class="op">&gt;=</span> <span class="dv">1</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">THEN</span> <span class="fu">SUBSTR</span>(t0.key3, <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="op">+</span> <span class="dv">1</span>, <span class="fu">CAST</span>(<span class="dv">4</span> <span class="kw">AS</span> TINYINT))</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span> <span class="fu">SUBSTR</span>(t0.key3, <span class="fu">CAST</span>(<span class="dv">0</span> <span class="kw">AS</span> TINYINT) <span class="op">+</span> <span class="dv">1</span> <span class="op">+</span> <span class="fu">LENGTH</span>(t0.key3), <span class="fu">CAST</span>(<span class="dv">4</span> <span class="kw">AS</span> TINYINT))</span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="non-equality-join-predicates" class="level3">
<h3 class="anchored" data-anchor-id="non-equality-join-predicates">Non-equality join predicates</h3>
<p>You can join tables with boolean clauses that are not equality. Some query engines support these efficiently, some inefficiently, or some not at all. In the latter case, these conditions get moved by Ibis into the <code>WHERE</code> part of the <code>SELECT</code> query.</p>
<div id="31581c13" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t1.join(t2, t1.value1 <span class="op">&lt;</span> t2.value2).group_by(t1.key1).size()</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<div class="sourceCode" id="cb122"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> <span class="ot">"CountStar()"</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> table2 <span class="kw">AS</span> t1</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t0.value1 <span class="op">&lt;</span> t1.value2</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="other-ways-to-specify-join-keys" class="level3">
<h3 class="anchored" data-anchor-id="other-ways-to-specify-join-keys">Other ways to specify join keys</h3>
<p>You can also pass a list of column names instead of forming boolean expressions:</p>
<div id="b2217a3c" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>joined <span class="op">=</span> t1.join(t2, [(<span class="st">"key1"</span>, <span class="st">"key3"</span>), (<span class="st">"key2"</span>, <span class="st">"key4"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="subqueries" class="level2">
<h2 class="anchored" data-anchor-id="subqueries">Subqueries</h2>
<p>Ibis creates inline views and nested subqueries automatically. This section concerns more complex subqueries involving foreign references and other advanced relational algebra.</p>
<section id="correlated-exists-not-exists-filters" class="level3">
<h3 class="anchored" data-anchor-id="correlated-exists-not-exists-filters">Correlated <code>EXISTS</code> / <code>NOT EXISTS</code> filters</h3>
<p>The SQL <code>EXISTS</code> and <code>NOT EXISTS</code> constructs are typically used for efficient filtering in large many-to-many relationships.</p>
<p>Let’s consider a web dataset involving website session / usage data and purchases:</p>
<div id="643b3b50" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>events <span class="op">=</span> ibis.table(</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(session_id<span class="op">=</span><span class="st">"int64"</span>, user_id<span class="op">=</span><span class="st">"int64"</span>, event_type<span class="op">=</span><span class="st">"int32"</span>, ts<span class="op">=</span><span class="st">"timestamp"</span>),</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"events"</span>,</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>purchases <span class="op">=</span> ibis.table(</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(item_id<span class="op">=</span><span class="st">"int64"</span>, user_id<span class="op">=</span><span class="st">"int64"</span>, price<span class="op">=</span><span class="st">"float"</span>, ts<span class="op">=</span><span class="st">"timestamp"</span>),</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"purchases"</span>,</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, the key <code>user_id</code> appears with high frequency in both tables. But let’s say you want to limit your analysis of the <code>events</code> table to only sessions by users who have made a purchase.</p>
<p>In SQL, you can do this using the somewhat esoteric <code>EXISTS</code> construct:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t0.<span class="op">*</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span> t0</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">EXISTS</span> (</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="dv">1</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> purchases t1</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> t0.user_id <span class="op">=</span> t1.user_id</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To describe this operation in Ibis, you compare the <code>user_id</code> columns and use the <code>any</code> reduction:</p>
<div id="ba90e3b1" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>cond <span class="op">=</span> (events.user_id <span class="op">==</span> purchases.user_id).<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This can now be used to filter <code>events</code>:</p>
<div id="f8e353da" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> events[cond]</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<div class="sourceCode" id="cb128"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  t0.session_id,</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  t0.user_id,</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>  t0.event_type,</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  t0.ts</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">AS</span> t0</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">EXISTS</span>(</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">CAST</span>(<span class="dv">1</span> <span class="kw">AS</span> TINYINT) <span class="kw">AS</span> anon_1</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> purchases <span class="kw">AS</span> t1</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>      t0.user_id <span class="op">=</span> t1.user_id</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>If you negate the condition, it will instead give you only event data from user <em>that have not made a purchase</em>:</p>
<div id="4d37f176" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> events[<span class="op">-</span>cond]</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<div class="sourceCode" id="cb130"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>  t0.session_id,</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>  t0.user_id,</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>  t0.event_type,</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  t0.ts</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">AS</span> t0</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">NOT</span> (</span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">EXISTS</span>(</span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">CAST</span>(<span class="dv">1</span> <span class="kw">AS</span> TINYINT) <span class="kw">AS</span> anon_1</span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">FROM</span> purchases <span class="kw">AS</span> t1</span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">WHERE</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>        t0.user_id <span class="op">=</span> t1.user_id</span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="subqueries-with-in-not-in" class="level3">
<h3 class="anchored" data-anchor-id="subqueries-with-in-not-in">Subqueries with <code>IN</code> / <code>NOT IN</code></h3>
<p>Subquery filters with <code>IN</code> (and <code>NOT IN</code>) are functionally similar to <code>EXISTS</code> subqueries. Let’s look at some SQL:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> user_id <span class="kw">IN</span> (</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> user_id</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> purchases</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is almost semantically the same as the <code>EXISTS</code> example. Indeed, you can write with Ibis:</p>
<div id="52650764" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>cond <span class="op">=</span> events.user_id.isin(purchases.user_id)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> events[cond]</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<div class="sourceCode" id="cb133"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  t0.session_id,</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  t0.user_id,</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>  t0.event_type,</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>  t0.ts</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">AS</span> t0</span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>  t0.user_id <span class="kw">IN</span> (</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>      t1.user_id</span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> purchases <span class="kw">AS</span> t1</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Depending on the query engine, the query planner/optimizer will often rewrite <code>IN</code> or <code>EXISTS</code> subqueries into the same set of relational algebra operations.</p>
</section>
<section id="comparison-with-scalar-aggregates" class="level3">
<h3 class="anchored" data-anchor-id="comparison-with-scalar-aggregates">Comparison with scalar aggregates</h3>
<p>Sometime you want to compare a value with an unconditional aggregate value from a different table. Take the SQL:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> value1 <span class="op">&gt;</span> (</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="fu">max</span>(value2)</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> table2</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With Ibis, the code is simpler and more pandas-like:</p>
<div id="f1777bea" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t1[t1.value1 <span class="op">&gt;</span> t2.value2.<span class="bu">max</span>()]</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<div class="sourceCode" id="cb136"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  t0.value1,</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  t0.key2</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>  t0.value1 <span class="op">&gt;</span> (</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">MAX</span>(t1.value2) <span class="kw">AS</span> <span class="ot">"Max(value2)"</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> table2 <span class="kw">AS</span> t1</span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="conditional-aggregates" class="level3">
<h3 class="anchored" data-anchor-id="conditional-aggregates">Conditional aggregates</h3>
<p>Suppose you want to compare a value with the aggregate value for some common group values between two tables. Here’s some SQL:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 t0</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> value1 <span class="op">&gt;</span> (</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span> <span class="fu">avg</span>(value2)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> table2 t1</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> t0.key1 <span class="op">=</span> t1.key3</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This query computes the average for each distinct value of <code>key3</code> and uses the corresponding average for the comparison, rather than the whole-table average as above.</p>
<p>With Ibis, the code is similar, but you add the correlated filter to the average statistic:</p>
<div id="ef24fb38" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>stat <span class="op">=</span> t2[t1.key1 <span class="op">==</span> t2.key3].value2.mean()</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t1[t1.value1 <span class="op">&gt;</span> stat]</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<div class="sourceCode" id="cb139"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  t0.value1,</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  t0.key2</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>  t0.value1 <span class="op">&gt;</span> (</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">AVG</span>(t1.value2) <span class="kw">AS</span> <span class="ot">"Mean(value2)"</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> table2 <span class="kw">AS</span> t1</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>      t0.key1 <span class="op">=</span> t1.key3</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="distinct-expressions" class="level2">
<h2 class="anchored" data-anchor-id="distinct-expressions"><code>DISTINCT</code> expressions</h2>
<p>In SQL, the <code>DISTINCT</code> keyword is used in a couple of ways:</p>
<ul>
<li>Deduplicating identical rows in some <code>SELECT</code> statement</li>
<li>Aggregating on the distinct values of some column expression</li>
</ul>
<p>Ibis supports both use cases. So let’s have a look. The first case is the simplest: call <code>distinct</code> on a table expression. First, here’s the SQL:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="op">*</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And the Ibis Python code:</p>
<div id="384710df" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t1.distinct()</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<div class="sourceCode" id="cb142"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  t0.value1,</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  t0.key2</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1 <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>For distinct aggregates, the most common case is <code>COUNT(DISTINCT ...)</code>, which computes the number of unique values in an expression. So if we’re looking at the <code>events</code> table, let’s compute the number of distinct <code>event_type</code> values for each <code>user_id</code>. First, the SQL:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> user_id, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> event_type) <span class="kw">AS</span> unique_events</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In Ibis this is:</p>
<div id="32eded9e" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> events.event_type.nunique()</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> events.group_by(<span class="st">"user_id"</span>).aggregate(unique_events<span class="op">=</span>metric)</span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<div class="sourceCode" id="cb145"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  t0.user_id,</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> t0.event_type) <span class="kw">AS</span> unique_events</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">AS</span> t0</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="window-functions" class="level2">
<h2 class="anchored" data-anchor-id="window-functions">Window functions</h2>
<p>Window functions in SQL allow you to write expressions that involve possibly-ordered groups of a table. Each window function involves one of the following:</p>
<ul>
<li>An analytic function. Most aggregate functions are valid analytic functions, and there are additional ones such as <code>LEAD</code>, <code>LAG</code>, <code>NTILE</code>, and others.</li>
<li>A <code>PARTITION BY</code> clause. This may be omitted.</li>
<li>An <code>ORDER BY</code> clause. This may be omitted for many functions.</li>
<li>A window frame clause. The default is to use the entire partition.</li>
</ul>
<p>So you may see SQL like:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AVG</span>(<span class="fu">value</span>) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> key1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Or simply</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AVG</span>(<span class="fu">value</span>) <span class="kw">OVER</span> ()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ibis will automatically write window clauses when you use aggregate functions in a non-aggregate context. Suppose you wanted to subtract the mean of a column from itself:</p>
<div id="56d60e11" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.mutate(two_demean<span class="op">=</span>t.two <span class="op">-</span> t.two.mean())</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<div class="sourceCode" id="cb149"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">-</span> <span class="fu">AVG</span>(t0.two) <span class="kw">OVER</span> (<span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">UNBOUNDED</span> <span class="kw">FOLLOWING</span>) <span class="kw">AS</span> two_demean</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>If you use <code>mutate</code> in conjunction with <code>group_by</code>, it will add a <code>PARTITION BY</code> to the <code>OVER</code> specification:</p>
<div id="247e1092" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.group_by(<span class="st">"one"</span>).mutate(two_demean<span class="op">=</span>t.two <span class="op">-</span> t.two.mean())</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<div class="sourceCode" id="cb151"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">-</span> <span class="fu">AVG</span>(t0.two) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> t0.one <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">UNBOUNDED</span> <span class="kw">FOLLOWING</span>) <span class="kw">AS</span> two_demean</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>For functions like <code>LAG</code> that require an ordering, we can add an <code>order_by</code> call:</p>
<div id="cf781092" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.group_by(<span class="st">"one"</span>).order_by(t.two).mutate(two_first_diff<span class="op">=</span>t.two <span class="op">-</span> t.two.lag())</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<div class="sourceCode" id="cb153"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">-</span> <span class="fu">LAG</span>(t0.two, <span class="dv">1</span>) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> t0.one <span class="kw">ORDER</span> <span class="kw">BY</span> t0.two <span class="kw">ASC</span> <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="kw">UNBOUNDED</span> <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="kw">UNBOUNDED</span> <span class="kw">FOLLOWING</span>) <span class="kw">AS</span> two_first_diff</span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>For more precision, you can create a <code>Window</code> object that also includes a window frame clause:</p>
<div id="b7bff57e" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> ibis.window(group_by<span class="op">=</span><span class="st">"one"</span>, preceding<span class="op">=</span><span class="dv">5</span>, following<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t.mutate(group_demeaned<span class="op">=</span>t.two <span class="op">-</span> t.two.mean().over(w))</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<div class="sourceCode" id="cb155"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  t0.one,</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  t0.two,</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  t0.three,</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>  t0.two <span class="op">-</span> <span class="fu">AVG</span>(t0.two) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> t0.one <span class="kw">ROWS</span> <span class="kw">BETWEEN</span> <span class="fu">CAST</span>(<span class="dv">5</span> <span class="kw">AS</span> TINYINT) <span class="kw">PRECEDING</span> <span class="kw">AND</span> <span class="fu">CAST</span>(<span class="dv">5</span> <span class="kw">AS</span> TINYINT) <span class="kw">FOLLOWING</span>) <span class="kw">AS</span> group_demeaned</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> my_data <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="top-k-operations" class="level2">
<h2 class="anchored" data-anchor-id="top-k-operations">Top-K operations</h2>
<p>A common SQL idiom is the “top-K” or “top-N” operation: subsetting a dimension by aggregate statistics:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> key1, <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> `count`</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> table1</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> `count` <span class="kw">DESC</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ibis has a special analytic expression <code>topk</code>:</p>
<div id="c42df5fe" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> t1.key1.topk(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This can be evaluated directly, yielding the above query:</p>
<div id="fefc2b9b" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="76">
<div class="sourceCode" id="cb159"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>  t0.<span class="ot">"Count(key1)"</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    t1.key1 <span class="kw">AS</span> key1,</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">COUNT</span>(t1.key1) <span class="kw">AS</span> <span class="ot">"Count(key1)"</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> table1 <span class="kw">AS</span> t1</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> t0</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>  t0.<span class="ot">"Count(key1)"</span> <span class="kw">DESC</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="date-time-data" class="level2">
<h2 class="anchored" data-anchor-id="date-time-data">Date / time data</h2>
<p>See <code class="interpreted-text" role="ref">Timestamp methods &lt;api.timestamp&gt;</code> for a table of available date/time methods.</p>
<p>For example, we can do:</p>
<div id="190e300c" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> events.mutate(year<span class="op">=</span>events.ts.year(), month<span class="op">=</span>events.ts.month())</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<div class="sourceCode" id="cb161"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>  t0.session_id,</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  t0.user_id,</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>  t0.event_type,</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>  t0.ts,</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">year</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">AS</span> <span class="dt">year</span>,</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CAST</span>(<span class="fu">EXTRACT</span>(<span class="dt">month</span> <span class="kw">FROM</span> t0.ts) <span class="kw">AS</span> <span class="dt">SMALLINT</span>) <span class="kw">AS</span> <span class="dt">month</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<section id="casting-to-date-time-types" class="level3">
<h3 class="anchored" data-anchor-id="casting-to-date-time-types">Casting to date / time types</h3>
<p>In many cases, you can convert string values to datetime / timestamp with <code>strings.cast('timestamp')</code>, but you may have to do some more reconnaissance into the data if this does not work.</p>
</section>
<section id="intervals" class="level3">
<h3 class="anchored" data-anchor-id="intervals">Intervals</h3>
<p>Ibis has a set of interval APIs that allow you to do date/time arithmetic. For example:</p>
<div id="fc850159" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> events[events.ts <span class="op">&gt;</span> (ibis.now() <span class="op">-</span> ibis.interval(years<span class="op">=</span><span class="dv">1</span>))]</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<div class="sourceCode" id="cb163"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  t0.session_id,</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  t0.user_id,</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>  t0.event_type,</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>  t0.ts</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> <span class="kw">events</span> <span class="kw">AS</span> t0</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>  t0.ts <span class="op">&gt;</span> <span class="fu">CAST</span>(NOW() <span class="kw">AS</span> <span class="dt">TIMESTAMP</span>) <span class="op">-</span> TO_YEARS(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The implementation of each timedelta offset will depend on the query engine.</p>
</section>
</section>
<section id="buckets-and-histograms" class="level2">
<h2 class="anchored" data-anchor-id="buckets-and-histograms">Buckets and histograms</h2>
<p>To appear.</p>
</section>
<section id="unions" class="level2">
<h2 class="anchored" data-anchor-id="unions">Unions</h2>
<p>SQL dialects often support two kinds of <code>UNION</code> operations:</p>
<ul>
<li><code>UNION</code>: the combination of <em>distinct</em> rows from each table.</li>
<li><code>UNION ALL</code>: the combination of all rows from each table, whether or not they are distinct.</li>
</ul>
<p>The Ibis <code>union</code> function by distinct is a <code>UNION ALL</code>, and you can set <code>distinct=True</code> to get the normal <code>UNION</code> behavior:</p>
<div id="d26f3e9b" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>expr1 <span class="op">=</span> t1.limit(<span class="dv">10</span>)</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>expr2 <span class="op">=</span> t1.limit(<span class="dv">10</span>, offset<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>expr <span class="op">=</span> expr1.union(expr2)</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(expr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="79">
<div class="sourceCode" id="cb165"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> anon_1 <span class="kw">AS</span> (</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    t1.value1 <span class="kw">AS</span> value1,</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>    t1.key1 <span class="kw">AS</span> key1,</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>    t1.key2 <span class="kw">AS</span> key2</span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> table1 <span class="kw">AS</span> t1</span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>), anon_2 <span class="kw">AS</span> (</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>    t1.value1 <span class="kw">AS</span> value1,</span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>    t1.key1 <span class="kw">AS</span> key1,</span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>    t1.key2 <span class="kw">AS</span> key2</span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> table1 <span class="kw">AS</span> t1</span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>  OFFSET <span class="dv">10</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>  t0.value1,</span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>  t0.key1,</span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>  t0.key2</span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> (</span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a>    anon_1.value1 <span class="kw">AS</span> value1,</span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a>    anon_1.key1 <span class="kw">AS</span> key1,</span>
<span id="cb165-25"><a href="#cb165-25" aria-hidden="true" tabindex="-1"></a>    anon_1.key2 <span class="kw">AS</span> key2</span>
<span id="cb165-26"><a href="#cb165-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> anon_1</span>
<span id="cb165-27"><a href="#cb165-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb165-28"><a href="#cb165-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb165-29"><a href="#cb165-29" aria-hidden="true" tabindex="-1"></a>    anon_2.value1 <span class="kw">AS</span> value1,</span>
<span id="cb165-30"><a href="#cb165-30" aria-hidden="true" tabindex="-1"></a>    anon_2.key1 <span class="kw">AS</span> key1,</span>
<span id="cb165-31"><a href="#cb165-31" aria-hidden="true" tabindex="-1"></a>    anon_2.key2 <span class="kw">AS</span> key2</span>
<span id="cb165-32"><a href="#cb165-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> anon_2</span>
<span id="cb165-33"><a href="#cb165-33" aria-hidden="true" tabindex="-1"></a>) <span class="kw">AS</span> t0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="esoterica" class="level2">
<h2 class="anchored" data-anchor-id="esoterica">Esoterica</h2>
<p>This area will be the spillover for miscellaneous SQL concepts and how queries featuring them can be ported to Ibis.</p>
<section id="common-table-expressions-ctes" class="level3">
<h3 class="anchored" data-anchor-id="common-table-expressions-ctes">Common table expressions (CTEs)</h3>
<p>The simplest SQL CTE is a SQL statement that is used multiple times in a <code>SELECT</code> query, which can be “factored” out using the <code>WITH</code> keyword:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> t0 <span class="kw">AS</span> (</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">SELECT</span> region, kind, <span class="fu">sum</span>(amount) <span class="kw">AS</span> total</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">FROM</span> purchases</span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">GROUP</span> <span class="kw">BY</span> <span class="dv">1</span>, <span class="dv">2</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t0.region, t0.total <span class="op">-</span> t1.total</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> t0</span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">INNER</span> <span class="kw">JOIN</span> t0 t1</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ON</span> t0.region <span class="op">=</span> t1.region</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> t0.kind <span class="op">=</span> <span class="st">'foo'</span> <span class="kw">AND</span> t1.kind <span class="op">=</span> <span class="st">'bar'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Explicit CTEs are not necessary with Ibis. Let’s look at an example involving joining an aggregated table on itself after filtering:</p>
<div id="1ecd0870" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>purchases <span class="op">=</span> ibis.table(</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(region<span class="op">=</span><span class="st">"string"</span>, kind<span class="op">=</span><span class="st">"string"</span>, user<span class="op">=</span><span class="st">"int64"</span>, amount<span class="op">=</span><span class="st">"float"</span>),</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"purchases"</span>,</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> purchases.amount.<span class="bu">sum</span>().name(<span class="st">"total"</span>)</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>agged <span class="op">=</span> purchases.group_by([<span class="st">"region"</span>, <span class="st">"kind"</span>]).aggregate(metric)</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>left <span class="op">=</span> agged[agged.kind <span class="op">==</span> <span class="st">"foo"</span>]</span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>right <span class="op">=</span> agged[agged.kind <span class="op">==</span> <span class="st">"bar"</span>]</span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> left.join(right, left.region <span class="op">==</span> right.region)[</span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>    left.region, (left.total <span class="op">-</span> right.total).name(<span class="st">"diff"</span>)</span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ibis automatically creates a CTE for <code>agged</code>:</p>
<div id="b5912985" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>ibis.to_sql(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<div class="sourceCode" id="cb169"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> t1 <span class="kw">AS</span> (</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>    t2.region <span class="kw">AS</span> region,</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    t2.kind <span class="kw">AS</span> kind,</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SUM</span>(t2.amount) <span class="kw">AS</span> total</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> purchases <span class="kw">AS</span> t2</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>    t2.kind <span class="op">=</span> <span class="st">'foo'</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>), t0 <span class="kw">AS</span> (</span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">SELECT</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>    t2.region <span class="kw">AS</span> region,</span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>    t2.kind <span class="kw">AS</span> kind,</span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">SUM</span>(t2.amount) <span class="kw">AS</span> total</span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> purchases <span class="kw">AS</span> t2</span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>    t2.kind <span class="op">=</span> <span class="st">'bar'</span></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>  t1.region,</span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a>  t1.total <span class="op">-</span> t0.total <span class="kw">AS</span> diff</span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> t1</span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a><span class="kw">JOIN</span> t0</span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ON</span> t1.region <span class="op">=</span> t0.region</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>


</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        console.log("RESIZE");
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ibis-project">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://ibis-project.zulipchat.com">
      <i class="bi bi-zulip" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://ibis-project.org/posts.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>