{
  "hash": "5877a193e5708897ecf259dbe61349fa",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Language models for data\"\nauthor: \"Cody Peterson\"\ndate: \"2024-02-05\"\nimage: thumbnail.png\ncategories:\n    - blog\n    - llms\n    - duckdb\n---\n\n## Overview\n\nThis post will give an overview of how (large) language models (LMs) fit into\ndata engineering, analyst, and science workflows.\n\n## Use cases\n\nThere are three main use cases for language models for data practitioners:\n\n1. Synthetic data generation\n2. Natural language processing\n3. Writing analytic code\n\nWe'll describe each and then demonstrate them with code.\n\n## Setup\n\nWe'll use [Marvin](https://askmarvin.ai), the AI engineering toolkit, alongside\n[Ibis](https://ibis-project.org), the data engineering toolkit, to demonstrate\nthe capabilities of language models for data using the default DuckDB backend.\n\n:::{.callout-tip}\nWe'll use a cloud service provider (OpenAI) to demonstrate these capabilities.\nIn a follow-up post, we'll explore using local \"open source\" language models to\nachieve the same results.\n:::\n\nWith Marvin and Ibis, you can replicate the workflows below using other AI\nservice providers, local language models, and over 20+ data backends!\n\nYou'll need to install Marvin and Ibis to follow along:\n\n```{.bash}\npip install 'ibis-framework[duckdb,examples]' marvin\n```\n\nThen import them and turn on Ibis interactive mode:\n\n::: {#fbe0fbc5 .cell execution_count=1}\n``` {.python .cell-code}\nimport ibis  # <1>\nimport marvin  # <2>\n\nfrom pydantic import BaseModel, Field  # <3>\n\nibis.options.interactive = True  # <4>\nibis.options.repr.interactive.max_rows = 6  # <5>\n```\n:::\n\n\n1. Import Ibis, the data engineering toolkit\n2. Import Marvin, the AI engineering toolkit\n3. Import Pydantic, used to define data models for Marvin\n4. Set Ibis to interactive mode to display the results of our queries\n5. Set the maximum number of rows to display in interactive mode\n\n## Synthetic data generation\n\nLanguage models can be used to generate synthetic data. This is useful for\ntesting, training, and other purposes. For example, you can use a language model\nto generate synthetic data for training a machine learning model (including a\nlanguage model).\n\n:::{.callout-tip}\nThis post was re-inspired by the [1 billion row challenge we recently solved\nwith Ibis on three local backends](../1brc/index.qmd) in which synthetic data\ngenerated from a seed file was used to generate a billion rows.\n\nWith language models, we can reproduce this synthetic data and customize the\ndata produced with natural language!\n:::\n\nWe'll start by replicating the data in the one billion row challenge, then move\nover to our favorite penguins demo dataset to augment existing data with\nsynthetic data.\n\n### Weather stations\n\nWe can generate synthetic weather stations in a few lines of code:\n\n::: {#e7db2fa1 .cell execution_count=2}\n``` {.python .cell-code}\nclass WeatherStation(BaseModel):  # <1>\n    station: str = Field(\n        ...,\n        description=\"The weather station name\",\n        example=\"Sandy Silicon\",\n    )  # <1>\n    temperature: float = Field(\n        ...,\n        description=\"The average temperature in Fahrenheit\",\n        example=72.5,\n    )  # <1>\n\n\nstations = marvin.generate(  # <2>\n    target=WeatherStation,  # <2>\n    instructions=\"Generate fictitious but plausible-sounding weather stations with names that excite data nerds\",  # <2>\n    n=6,  # <2>\n)  # <2>\nstations\n```\n\n::: {.cell-output .cell-output-display execution_count=2}\n```\n[WeatherStation(station='Quantum Quasar', temperature=68.3),\n WeatherStation(station='Neural Network Nexus', temperature=74.2),\n WeatherStation(station='Data Driven Delta', temperature=59.1),\n WeatherStation(station='Algorithmic Aurora', temperature=48.6),\n WeatherStation(station='Pattern Recognition Ridge', temperature=62.8),\n WeatherStation(station='Matrix Monsoon', temperature=88.9)]\n```\n:::\n:::\n\n\n1. Define a data model for the weather stations\n2. Use Marvin to generate three weather stations\n\nAnd then load that data into an Ibis table:\n\n:::{.callout-tip}\nYou could also use a user-defined function (UDF) to directly generate this data\nin a table. We'll demonstrate UDFs throughout this post.\n:::\n\n::: {#24c0638e .cell execution_count=3}\n``` {.python .cell-code}\ns = ibis.memtable([station.model_dump() for station in stations]) # <1>\ns\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┓\n┃<span style=\"font-weight: bold\"> station                   </span>┃<span style=\"font-weight: bold\"> temperature </span>┃\n┡━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>     │\n├───────────────────────────┼─────────────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Quantum Quasar           </span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">68.3</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Neural Network Nexus     </span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">74.2</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Data Driven Delta        </span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">59.1</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Algorithmic Aurora       </span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">48.6</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Pattern Recognition Ridge</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">62.8</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Matrix Monsoon           </span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">88.9</span> │\n└───────────────────────────┴─────────────┘\n</pre>\n```\n:::\n:::\n\n\n1. Convert the generated data to an Ibis table\n\nWhile we've only generated six weather stations, you can repeat this process\nuntil you get as many as you'd like! You can then use Ibis to generate a billion\nrows of weather data for these stations as in the one billion row challenge.\n\n:::{.callout-warning}\nRunning this with GPT-4-turbo to generate 1000 weather stations (with `n=10` and\nfeeding in all previous attempts to the prompt to attempt avoiding duplicates)\ncosts about $4 USD and resulted in about 150 duplicates. This is rather\nexpensive for synthetic data! You can mitigate this by using a cheaper model\n(e.g. GPT-3.5-turbo) but may get worse results.\n\nAlternatively, you can generate the data for free on your laptop with a small\nopen source language model! Look out for a future post exploring this option.\n:::\n\n### Penguin poems\n\nWe can augment existing data with synthetic data. First, let's load the penguins\ndataset:\n\n::: {#783cee0d .cell execution_count=4}\n``` {.python .cell-code}\npenguins = ibis.examples.penguins.fetch()  # <1>\npenguins\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┓\n┃<span style=\"font-weight: bold\"> species </span>┃<span style=\"font-weight: bold\"> island    </span>┃<span style=\"font-weight: bold\"> bill_length_mm </span>┃<span style=\"font-weight: bold\"> bill_depth_mm </span>┃<span style=\"font-weight: bold\"> flipper_length_mm </span>┃<span style=\"font-weight: bold\"> body_mass_g </span>┃<span style=\"font-weight: bold\"> sex    </span>┃<span style=\"font-weight: bold\"> year  </span>┃\n┡━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span> │\n├─────────┼───────────┼────────────────┼───────────────┼───────────────────┼─────────────┼────────┼───────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">39.1</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.7</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">181</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3750</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">39.5</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">17.4</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">186</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3800</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">40.3</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.0</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">195</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3250</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>   │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">36.7</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">19.3</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">193</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">39.3</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">20.6</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">190</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3650</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>         │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>      │     <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │\n└─────────┴───────────┴────────────────┴───────────────┴───────────────────┴─────────────┴────────┴───────┘\n</pre>\n```\n:::\n:::\n\n\n1. Load the penguins dataset from Ibis examples\n\nAnd take a sample of five rows to reduce our AI service costs:\n\n::: {#a23a6372 .cell execution_count=5}\n``` {.python .cell-code}\n# t = penguins.sample(fraction=0.025).limit(5) # <1>\nt1 = penguins.filter(penguins.species == \"Adelie\").sample(fraction=0.1).limit(2)  # <1>\nt2 = penguins.filter(penguins.species == \"Gentoo\").sample(fraction=0.1).limit(2)  # <1>\nt3 = (  # <1>\n    penguins.filter(penguins.species == \"Chinstrap\")  # <1>\n    .sample(fraction=0.1)  # <1>\n    .limit(2)  # <1>\n)  # <1>\nt = t1.union(t2).union(t3)  # <2>\nt\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┓\n┃<span style=\"font-weight: bold\"> species   </span>┃<span style=\"font-weight: bold\"> island    </span>┃<span style=\"font-weight: bold\"> bill_length_mm </span>┃<span style=\"font-weight: bold\"> bill_depth_mm </span>┃<span style=\"font-weight: bold\"> flipper_length_mm </span>┃<span style=\"font-weight: bold\"> body_mass_g </span>┃<span style=\"font-weight: bold\"> sex    </span>┃<span style=\"font-weight: bold\"> year  </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span> │\n├───────────┼───────────┼────────────────┼───────────────┼───────────────────┼─────────────┼────────┼───────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">36.7</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">19.3</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">193</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">38.7</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">19.0</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">195</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">49.2</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">15.2</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">221</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6300</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">50.2</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">14.3</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">218</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">5700</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">45.2</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">17.8</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">198</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3950</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.4</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.6</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">190</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n└───────────┴───────────┴────────────────┴───────────────┴───────────────────┴─────────────┴────────┴───────┘\n</pre>\n```\n:::\n:::\n\n\n1. Sample two rows from each species\n2. Union the samples together\n\nNow we define a UDF to generate a poem to describe each penguin:\n\n::: {#9d26162f .cell execution_count=6}\n``` {.python .cell-code}\n@ibis.udf.scalar.python  # <1>\ndef penguin_poem(  # <1>\n    species: str,  # <1>\n    island: str,  # <1>\n    bill_length_mm: float,  # <1>\n    bill_depth_mm: float,  # <1>\n    flipper_length_mm: float,  # <1>\n    body_mass_g: float,  # <1>\n) -> str:  # <1>\n    # <2>\n    instructions = f\"\"\"Provide a whimsical poem that rhymes for a penguin.\n\n    You have the following information about the penguins:\n        species {species}\n        island of {island}\n        bill length of {bill_length_mm} mm\n        bill depth of {bill_depth_mm} mm\n        flipper length of {flipper_length_mm} mm\n        body mass of {body_mass_g} g.\n\n    You must reference the penguin's size in addition to its species and island.\n    \"\"\"  # <2>\n\n    poem = marvin.generate(  # <3>\n        n=1,  # <3>\n        instructions=instructions,  # <3>\n    )  # <3>\n\n    return poem[0]  # <4>\n```\n:::\n\n\n1. Define a scalar Python UDF to generate a poem from penguin data\n2. Augment the LM's prompt with the penguin data\n3. Use Marvin to generate a poem for the penguin data\n4. Return the generated poem\n\nAnd apply that UDF to our penguins table:\n\n::: {#7702182b .cell execution_count=7}\n``` {.python .cell-code}\nt = (\n    t.mutate(  # <1>\n        poem=penguin_poem(  # <1>\n            t.species,  # <1>\n            t.island,  # <1>\n            t.bill_length_mm,  # <1>\n            t.bill_depth_mm,  # <1>\n            t.flipper_length_mm,  # <1>\n            t.body_mass_g,  # <1>\n        )  # <1>\n    )\n    .relocate(\"species\", \"island\", \"poem\")  # <2>\n    .cache()  # <3>\n)\nt\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<script type=\"application/vnd.jupyter.widget-view+json\">\n{\"model_id\":\"c670fac3882547ebbf7cb74a1e47da0e\",\"version_major\":2,\"version_minor\":0,\"quarto_mimetype\":\"application/vnd.jupyter.widget-view+json\"}\n</script>\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┓\n┃<span style=\"font-weight: bold\"> species   </span>┃<span style=\"font-weight: bold\"> island    </span>┃<span style=\"font-weight: bold\"> poem                                                                               </span>┃<span style=\"font-weight: bold\"> bill_length_mm </span>┃<span style=\"font-weight: bold\"> bill_depth_mm </span>┃<span style=\"font-weight: bold\"> flipper_length_mm </span>┃<span style=\"font-weight: bold\"> body_mass_g </span>┃<span style=\"font-weight: bold\"> sex    </span>┃<span style=\"font-weight: bold\"> year  </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                                                                             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span> │\n├───────────┼───────────┼────────────────────────────────────────────────────────────────────────────────────┼────────────────┼───────────────┼───────────────────┼─────────────┼────────┼───────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's land so chilly and grand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A dapper Adelie penguin took a stand.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">39.5</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">17.4</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">186</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3800</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's realm of snow and ice,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A penguin lives, both small and nice.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">An …</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>   │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Biscoe's lands, where icebergs stand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Gentoo at the sea's command,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With fl…</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.1</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.2</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">211</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4500</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On Biscoe's shores, 'neath skies so blue,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">The Gentoo tribe makes quite the view… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">40.9</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.7</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">214</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4650</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Dream island's frosty scope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Chinstrap penguin full of hope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With bill so …</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">52.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.1</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">201</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4050</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On the isle of Dream, where the icebergs gleam,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Lives a Chinstrap chap with a q… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.4</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.6</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">190</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n└───────────┴───────────┴────────────────────────────────────────────────────────────────────────────────────┴────────────────┴───────────────┴───────────────────┴─────────────┴────────┴───────┘\n</pre>\n```\n:::\n:::\n\n\n1. Apply the UDF by mutating the table with the function, using other columns as\n input\n2. Rearrange the columns we care about to the front\n3. Cache the table to avoid re-running the UDF\n\n:::{.callout-note title=\"Is this RAG?\" collapse=\"true\"}\nRetrieval augmented generation (RAG) is a term for retrieving information,\naugmenting the prompt input to a language model with that information, and using\nthat prompt to generate a response with improved accuracy.\n\nIn the example above, we've retrieved information from a table (that could be in\na remote database) and used it to augment the prompt input to a language model.\nThe model then generated a response that incorporates the retrieved information,\nimproving accuracy.\n\n> I would like to abolish the term RAG and instead just agree that we should\n> always try to provide models with the appropriate context to provide high\n> quality answers. - [Hamel\n> Husain](https://twitter.com/HamelHusain/status/1709740984643596768)\n\nI would consider this RAG, but I also consider RAG to be a silly term.\n:::\n\nNice! While not particularly useful in this case, the same process can be used\nfor generating product descriptions or other practical applications.\n\n## Natural language processing\n\nThis includes tasks like:\n\n- sentiment analysis\n- named entity recognition\n- part of speech tagging\n- summarization\n- translation\n- question answering\n\nEach of these tasks can be, to some extent, solved by traditional natural\nlanguage processing (NLP) techniques. However, modern-day LMs can solve these\ntasks with a single model, and often with state-of-the-art performance. This\ndrastically simplifies what a single engineer, who doesn't need a deep\nunderstanding of NLP or ML in general, can accomplish.\n\n### Sentiment analysis\n\nWe can use a language model to perform sentiment analysis on the penguin poems:\n\n::: {#d2056947 .cell execution_count=8}\n``` {.python .cell-code}\n@marvin.fn  # <1>\ndef _sentiment_analysis(text: str) -> float:  # <1>\n    \"\"\"Returns a sentiment score for `text`\n    between -1 (negative) and 1 (positive).\"\"\"  # <1>\n\n\n@ibis.udf.scalar.python  # <2>\ndef sentiment_analysis(text: str) -> float:  # <2>\n    return _sentiment_analysis(text)  # <3>\n```\n:::\n\n\n1. Define a Marvin function to perform sentiment analysis\n2. Define a scalar Python UDF to apply the Marvin function to a column\n3. Apply the Marvin function within the UDF\n\nAnd apply that UDF to our penguins table:\n\n::: {#58efc019 .cell execution_count=9}\n``` {.python .cell-code}\nt = (\n    t.mutate(sentiment=sentiment_analysis(t.poem))  # <1>\n    .relocate(t.columns[:3], \"sentiment\")  # <2>\n    .cache()  # <3>\n)\nt\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<script type=\"application/vnd.jupyter.widget-view+json\">\n{\"model_id\":\"cee2ed4e75204098858d51665f93db30\",\"version_major\":2,\"version_minor\":0,\"quarto_mimetype\":\"application/vnd.jupyter.widget-view+json\"}\n</script>\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=9}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┓\n┃<span style=\"font-weight: bold\"> species   </span>┃<span style=\"font-weight: bold\"> island    </span>┃<span style=\"font-weight: bold\"> poem                                                                               </span>┃<span style=\"font-weight: bold\"> sentiment </span>┃<span style=\"font-weight: bold\"> bill_length_mm </span>┃<span style=\"font-weight: bold\"> bill_depth_mm </span>┃<span style=\"font-weight: bold\"> flipper_length_mm </span>┃<span style=\"font-weight: bold\"> body_mass_g </span>┃<span style=\"font-weight: bold\"> sex    </span>┃<span style=\"font-weight: bold\"> year  </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                                                                             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>   │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span> │\n├───────────┼───────────┼────────────────────────────────────────────────────────────────────────────────────┼───────────┼────────────────┼───────────────┼───────────────────┼─────────────┼────────┼───────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's land so chilly and grand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A dapper Adelie penguin took a stand.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.4</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">39.5</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">17.4</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">186</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3800</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's realm of snow and ice,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A penguin lives, both small and nice.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">An …</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.9</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>   │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Biscoe's lands, where icebergs stand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Gentoo at the sea's command,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With fl…</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.1</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.2</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">211</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4500</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On Biscoe's shores, 'neath skies so blue,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">The Gentoo tribe makes quite the view… </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.8</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">40.9</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.7</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">214</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4650</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Dream island's frosty scope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Chinstrap penguin full of hope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With bill so …</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.8</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">52.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.1</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">201</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4050</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On the isle of Dream, where the icebergs gleam,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Lives a Chinstrap chap with a q… </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.7</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.4</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.6</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">190</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n└───────────┴───────────┴────────────────────────────────────────────────────────────────────────────────────┴───────────┴────────────────┴───────────────┴───────────────────┴─────────────┴────────┴───────┘\n</pre>\n```\n:::\n:::\n\n\n1. Apply the UDF by mutating the table with the function\n2. Rearrange the columns we care about to the front\n3. Cache the table to avoid re-running the UDF\n\n### Entity extraction\n\nWhile not exactly named entity recognition, we can extract arbitrary entities\nfrom text. In this case, we'll extract a list of words that rhyme from the poem:\n\n::: {#d9b9ce3d .cell execution_count=10}\n``` {.python .cell-code}\n@ibis.udf.scalar.python  # <1>\ndef extract_rhyming_words(text: str) -> list[str]:  # <1>\n    words = marvin.extract(  # <2>\n        text,  # <2>\n        instructions=\"Extract the primary rhyming words from the text\",  # <2>\n    )  # <2>\n\n    return words  # <3>\n```\n:::\n\n\n1. Define a scalar Python UDF to extract rhyming words from a poem\n2. Use Marvin to extract the rhyming words from the poem\n3. Return the list of extracted words\n\nAnd apply that UDF to our penguins table:\n\n::: {#981fac92 .cell execution_count=11}\n``` {.python .cell-code}\nt = (\n    t.mutate(rhyming_words=extract_rhyming_words(t.poem))  # <1>\n    .relocate(t.columns[:4], \"rhyming_words\")  # <2>\n    .cache()  # <3>\n)\nt\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<script type=\"application/vnd.jupyter.widget-view+json\">\n{\"model_id\":\"45d075fb30a0480b89a5718f3574acb5\",\"version_major\":2,\"version_minor\":0,\"quarto_mimetype\":\"application/vnd.jupyter.widget-view+json\"}\n</script>\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=11}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┓\n┃<span style=\"font-weight: bold\"> species   </span>┃<span style=\"font-weight: bold\"> island    </span>┃<span style=\"font-weight: bold\"> poem                                                                               </span>┃<span style=\"font-weight: bold\"> sentiment </span>┃<span style=\"font-weight: bold\"> rhyming_words                 </span>┃<span style=\"font-weight: bold\"> bill_length_mm </span>┃<span style=\"font-weight: bold\"> bill_depth_mm </span>┃<span style=\"font-weight: bold\"> flipper_length_mm </span>┃<span style=\"font-weight: bold\"> body_mass_g </span>┃<span style=\"font-weight: bold\"> sex    </span>┃<span style=\"font-weight: bold\"> year  </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                                                                             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>   │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">array&lt;string&gt;</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span> │\n├───────────┼───────────┼────────────────────────────────────────────────────────────────────────────────────┼───────────┼───────────────────────────────┼────────────────┼───────────────┼───────────────────┼─────────────┼────────┼───────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's land so chilly and grand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A dapper Adelie penguin took a stand.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.4</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'grand'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'stand'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6</span><span style=\"font-weight: bold\">]</span>    │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">39.5</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">17.4</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">186</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3800</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's realm of snow and ice,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A penguin lives, both small and nice.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">An …</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.9</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'realm'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'nice'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span>    │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>   │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Biscoe's lands, where icebergs stand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Gentoo at the sea's command,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With fl…</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'lands'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'command'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.1</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.2</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">211</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4500</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On Biscoe's shores, 'neath skies so blue,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">The Gentoo tribe makes quite the view… </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.8</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'blue'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'view'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span>     │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">40.9</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.7</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">214</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4650</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Dream island's frosty scope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Chinstrap penguin full of hope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With bill so …</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.8</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'scope'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'hope'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6</span><span style=\"font-weight: bold\">]</span>     │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">52.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.1</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">201</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4050</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On the isle of Dream, where the icebergs gleam,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Lives a Chinstrap chap with a q… </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.7</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'Dream'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'gleam'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">12</span><span style=\"font-weight: bold\">]</span>   │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.4</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.6</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">190</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n└───────────┴───────────┴────────────────────────────────────────────────────────────────────────────────────┴───────────┴───────────────────────────────┴────────────────┴───────────────┴───────────────────┴─────────────┴────────┴───────┘\n</pre>\n```\n:::\n:::\n\n\n1. Apply the UDF by mutating the table with the function\n2. Rearrange the columns we care about to the front\n3. Cache the table to avoid re-running the UDF\n\n### Translation\n\nWe can translate the penguin poems into Spanish or any language the language\nmodel sufficiently knows:\n\n::: {#eb65affc .cell execution_count=12}\n``` {.python .cell-code}\n@marvin.fn  # <1>\ndef _translate_text(text: str, target_language: str = \"spanish\") -> str:  # <1>\n    \"\"\"Translate `text` to `target_language`.\"\"\"  # <1>\n\n\n@ibis.udf.scalar.python  # <2>\ndef translate_text(text: str, target_language: str = \"spanish\") -> str:  # <2>\n    return _translate_text(text, target_language)  # <3>\n```\n:::\n\n\n1. Define a Marvin function to translate text\n2. Define a scalar Python UDF to apply the Marvin function to a column\n3. Apply the Marvin function within the UDF\n\nAnd apply that UDF to our penguins table:\n\n::: {#3e686d6d .cell execution_count=13}\n``` {.python .cell-code}\nt = (\n    t.mutate(translated_poem=translate_text(t.poem)) # <1>\n    .relocate(t.columns[:5], \"translated_poem\") # <2>\n    .cache() # <3>\n)\nt\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<script type=\"application/vnd.jupyter.widget-view+json\">\n{\"model_id\":\"c8577fa601dc4f309d254613821ed75b\",\"version_major\":2,\"version_minor\":0,\"quarto_mimetype\":\"application/vnd.jupyter.widget-view+json\"}\n</script>\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=13}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┓\n┃<span style=\"font-weight: bold\"> species   </span>┃<span style=\"font-weight: bold\"> island    </span>┃<span style=\"font-weight: bold\"> poem                                                                               </span>┃<span style=\"font-weight: bold\"> sentiment </span>┃<span style=\"font-weight: bold\"> rhyming_words                 </span>┃<span style=\"font-weight: bold\"> translated_poem                                                                    </span>┃<span style=\"font-weight: bold\"> bill_length_mm </span>┃<span style=\"font-weight: bold\"> bill_depth_mm </span>┃<span style=\"font-weight: bold\"> flipper_length_mm </span>┃<span style=\"font-weight: bold\"> body_mass_g </span>┃<span style=\"font-weight: bold\"> sex    </span>┃<span style=\"font-weight: bold\"> year  </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                                                                             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>   │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">array&lt;string&gt;</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                                                                             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span> │\n├───────────┼───────────┼────────────────────────────────────────────────────────────────────────────────────┼───────────┼───────────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┼────────────────┼───────────────┼───────────────────┼─────────────┼────────┼───────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's land so chilly and grand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A dapper Adelie penguin took a stand.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.4</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'grand'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'stand'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6</span><span style=\"font-weight: bold\">]</span>    │ <span style=\"color: #008000; text-decoration-color: #008000\">En la tierra de Torgersen tan fr\\u00eda y grandiosa, </span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Un ping\\u00fcino Adelie e… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">39.5</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">17.4</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">186</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3800</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's realm of snow and ice,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A penguin lives, both small and nice.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">An …</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.9</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'realm'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'nice'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span>    │ <span style=\"color: #008000; text-decoration-color: #008000\">En el reino de Torgersen de nieve y hielo,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">un pingüino vive, pequeño y amable.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>   │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Biscoe's lands, where icebergs stand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Gentoo at the sea's command,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With fl…</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'lands'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'command'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">En tierras de Biscoe, donde los icebergs se alzan,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Un Gentoo al mando del mar,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.1</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.2</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">211</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4500</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On Biscoe's shores, 'neath skies so blue,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">The Gentoo tribe makes quite the view… </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.8</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'blue'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'view'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span>     │ <span style=\"color: #008000; text-decoration-color: #008000\">En las costas de Biscoe, bajo cielos tan azules,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">La tribu Gentoo ofrece un espe… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">40.9</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.7</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">214</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4650</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Dream island's frosty scope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Chinstrap penguin full of hope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With bill so …</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.8</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'scope'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'hope'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6</span><span style=\"font-weight: bold\">]</span>     │ <span style=\"color: #008000; text-decoration-color: #008000\">En la helada extensi\\u00f3n de la isla de los sue\\u00f1os,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">un ping\\u00fcino bar… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">52.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.1</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">201</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4050</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On the isle of Dream, where the icebergs gleam,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Lives a Chinstrap chap with a q… </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.7</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'Dream'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'gleam'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">12</span><span style=\"font-weight: bold\">]</span>   │ <span style=\"color: #008000; text-decoration-color: #008000\">En la isla de Dream, donde brillan los icebergs,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Vive un tipo de barbijo con un… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.4</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.6</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">190</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n└───────────┴───────────┴────────────────────────────────────────────────────────────────────────────────────┴───────────┴───────────────────────────────┴────────────────────────────────────────────────────────────────────────────────────┴────────────────┴───────────────┴───────────────────┴─────────────┴────────┴───────┘\n</pre>\n```\n:::\n:::\n\n\n1. Apply the UDF by mutating the table with the function\n2. Rearrange the columns we care about to the front\n3. Cache the table to avoid re-running the UDF\n\n## Writing analytical code\n\nFinally, language models can be used to write code. This is more useful with\nsystems around them to execute code, feed back error messages, make adjustments,\nand so on. There are numerous pitfalls with language models writing code, but\nthey're fairly good at SQL.\n\n### Three approaches\n\nWe can think of three approaches to writing analytical code with language\nmodels:\n\n1. Use LMs in an analytic subroutine\n2. Use LMs to write an analytic subroutine\n3. Use LMs to write analytic code\n\nWe've already seen numerous examples of the first approach above. Let's explore\nthe second and third approaches.\n\n### Writing an analytic subroutine\n\nWe'll define a function that writes an Ibis UDF, similar to what we've used\nabove:\n\n::: {#7530cadc .cell execution_count=14}\n``` {.python .cell-code}\n@marvin.fn\ndef _generate_python_function(text: str) -> str:\n    \"\"\"Generate a simple, typed, correct Python function from text.\"\"\"\n\n\ndef create_udf_from_text(text: str) -> str:\n    \"\"\"Create a UDF from text.\"\"\"\n    return f\"\"\"\nimport ibis\n\n@ibis.udf.scalar.python\n{_generate_python_function(text)}\n\"\"\".strip()\n```\n:::\n\n\nNow we'll create a UDF from text to count the number of vowels in a string:\n\n::: {#28424696 .cell execution_count=15}\n``` {.python .cell-code}\nudf = create_udf_from_text(\n    \"a function named count_vowels that given an input string, returns an int w/ the number of vowels (y_included as a boolean option defaulted to False). NO DOCSTRING, we don't document our code in this household\"\n)\nprint(udf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nimport ibis\n\n@ibis.udf.scalar.python\ndef count_vowels(input_string: str, y_included: bool = False) -> int:\n    vowels = 'aeiou' + ('y' if y_included else '')\n    return sum(1 for char in input_string.lower() if char in vowels)\n```\n:::\n:::\n\n\nAnd execute that so the UDF is available:\n\n::: {#de3e97ce .cell execution_count=16}\n``` {.python .cell-code}\nexec(udf)\n```\n:::\n\n\nNow we can augment our table with an analytic subroutine written by a language\nmodel:\n\n::: {#02780d2c .cell execution_count=17}\n``` {.python .cell-code}\nt = (\n    t.mutate(island_vowel_count=count_vowels(t.island),\n                species_vowel_count=count_vowels(t.species))\n    .relocate(\"island\", \"island_vowel_count\", \"species\", \"species_vowel_count\")\n)\nt\n```\n\n::: {.cell-output .cell-output-display execution_count=17}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━┓\n┃<span style=\"font-weight: bold\"> island    </span>┃<span style=\"font-weight: bold\"> island_vowel_count </span>┃<span style=\"font-weight: bold\"> species   </span>┃<span style=\"font-weight: bold\"> species_vowel_count </span>┃<span style=\"font-weight: bold\"> poem                                                                               </span>┃<span style=\"font-weight: bold\"> sentiment </span>┃<span style=\"font-weight: bold\"> rhyming_words                 </span>┃<span style=\"font-weight: bold\"> translated_poem                                                                    </span>┃<span style=\"font-weight: bold\"> bill_length_mm </span>┃<span style=\"font-weight: bold\"> bill_depth_mm </span>┃<span style=\"font-weight: bold\"> flipper_length_mm </span>┃<span style=\"font-weight: bold\"> body_mass_g </span>┃<span style=\"font-weight: bold\"> sex    </span>┃<span style=\"font-weight: bold\"> year  </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>              │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>               │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                                                                             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>   │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">array&lt;string&gt;</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                                                                             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span> │\n├───────────┼────────────────────┼───────────┼─────────────────────┼────────────────────────────────────────────────────────────────────────────────────┼───────────┼───────────────────────────────┼────────────────────────────────────────────────────────────────────────────────────┼────────────────┼───────────────┼───────────────────┼─────────────┼────────┼───────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's land so chilly and grand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A dapper Adelie penguin took a stand.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.4</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'grand'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'stand'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6</span><span style=\"font-weight: bold\">]</span>    │ <span style=\"color: #008000; text-decoration-color: #008000\">En la tierra de Torgersen tan fr\\u00eda y grandiosa, </span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Un ping\\u00fcino Adelie e… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">39.5</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">17.4</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">186</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3800</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Torgersen's realm of snow and ice,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A penguin lives, both small and nice.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">An …</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.9</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'realm'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'nice'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span>    │ <span style=\"color: #008000; text-decoration-color: #008000\">En el reino de Torgersen de nieve y hielo,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">un pingüino vive, pequeño y amable.</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>   │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Biscoe's lands, where icebergs stand,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Gentoo at the sea's command,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With fl…</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'lands'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'command'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">En tierras de Biscoe, donde los icebergs se alzan,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Un Gentoo al mando del mar,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">…</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.1</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.2</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">211</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4500</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On Biscoe's shores, 'neath skies so blue,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">The Gentoo tribe makes quite the view… </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.8</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'blue'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'view'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10</span><span style=\"font-weight: bold\">]</span>     │ <span style=\"color: #008000; text-decoration-color: #008000\">En las costas de Biscoe, bajo cielos tan azules,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">La tribu Gentoo ofrece un espe… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">40.9</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">13.7</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">214</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4650</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">In Dream island's frosty scope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">A Chinstrap penguin full of hope,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">With bill so …</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.8</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'scope'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'hope'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6</span><span style=\"font-weight: bold\">]</span>     │ <span style=\"color: #008000; text-decoration-color: #008000\">En la helada extensi\\u00f3n de la isla de los sue\\u00f1os,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">un ping\\u00fcino bar… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">52.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.1</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">201</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4050</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">male  </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">On the isle of Dream, where the icebergs gleam,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Lives a Chinstrap chap with a q… </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.7</span> │ <span style=\"font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'Dream'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'gleam'</span>, <span style=\"color: #808000; text-decoration-color: #808000\">...</span> +<span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">12</span><span style=\"font-weight: bold\">]</span>   │ <span style=\"color: #008000; text-decoration-color: #008000\">En la isla de Dream, donde brillan los icebergs,</span><span style=\"color: #d78700; text-decoration-color: #d78700\">\\n</span><span style=\"color: #008000; text-decoration-color: #008000\">Vive un tipo de barbijo con un… </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">46.4</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">18.6</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">190</span> │        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3450</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">female</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2007</span> │\n└───────────┴────────────────────┴───────────┴─────────────────────┴────────────────────────────────────────────────────────────────────────────────────┴───────────┴───────────────────────────────┴────────────────────────────────────────────────────────────────────────────────────┴────────────────┴───────────────┴───────────────────┴─────────────┴────────┴───────┘\n</pre>\n```\n:::\n:::\n\n\n:::{.callout-note}\nYou could use a LM to write a subroutine that uses a LM! This is an exercise\nleft to the reader.\n:::\n\n### Writing analytic code\n\nLet's define a function that outputs SQL:\n\n::: {#f9ce1438 .cell execution_count=18}\n``` {.python .cell-code}\n@marvin.fn  # <1>\ndef _text_to_sql(\n    text: str,\n    table_names: list[str],\n    table_schemas: list[str],\n    table_previews: list[str],\n) -> str:\n    \"\"\"Writes a SQL SELECT statement for the `text` given the provided `table_names`, `table_schemas`, and `table_previews`.\"\"\"  # <1>\n\n\ndef text_to_sql(  # <2>\n    text: str,  # <2>\n    table_names: list[str],  # <2>\n    table_schemas: list[str],  # <2>\n    table_previews: list[str],  # <2>\n) -> str:  # <2>\n    sql = _text_to_sql(text, table_names, table_schemas, table_previews)  # <3>\n    return sql.strip().strip(\";\")  # <4>\n```\n:::\n\n\n1. Define a Marvin function to write SQL from text\n2. Define a Python function to apply the Marvin function to a string\n3. Generate the SQL string\n4. Strip the trailing whitespace and semicolon that is sometimes generated, as\n it causes issues with Ibis\n\nWe can try that out on our penguins table:\n\n::: {#7d5b9aac .cell execution_count=19}\n``` {.python .cell-code}\ntext = (  # <1>\n    \"the count of penguins by species, from highest to lowest, per each island\"  # <1>\n)\n\ntable_names = [\"penguins\"]  # <2>\ntable_schemas = [str(penguins.schema())]  # <2>\ntable_previews = [str(penguins.limit(5))]  # <2>\n\nsql = text_to_sql(text, table_names, table_schemas, table_previews)  # <3>\nprint(sql)\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"></pre>\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nSELECT species, island, COUNT(*) AS count \nFROM penguins \nGROUP BY island, species \nORDER BY COUNT(*) DESC, island, species\n```\n:::\n:::\n\n\n1. Create a natural language query\n2. Provide the table names, schemas, and previews\n3. Generate the SQL string\n\nAnd execute the SQL:\n\n::: {#c73849e0 .cell execution_count=20}\n``` {.python .cell-code}\nr = penguins.sql(sql) # <1>\nr\n```\n\n::: {.cell-output .cell-output-display execution_count=20}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━┓\n┃<span style=\"font-weight: bold\"> species   </span>┃<span style=\"font-weight: bold\"> island    </span>┃<span style=\"font-weight: bold\"> count </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span> │\n├───────────┼───────────┼───────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Gentoo   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">124</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Chinstrap</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">68</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Dream    </span> │    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">56</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Torgersen</span> │    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">52</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">Adelie   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Biscoe   </span> │    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">44</span> │\n└───────────┴───────────┴───────┘\n</pre>\n```\n:::\n:::\n\n\n1. Execute the SQL string on the table\n\n:::{.callout-note title=\"This is definitely RAG\"}\nIn this case, we've retrieved a table's name, schema, and a preview of its data\nto generate a high-quality SQL query. We're definitely doing RAG now.\n\nWhile most RAG implementations use a similarity metric between text converted to\nnumberes (tokens/word embeddings), I find simple text retrieval in a\nwell-organized knowledge base to be more effective. We'll follow up on this in\nfuture posts.\n:::\n\n#### A more complex example\n\nLet's see how this works on a query that requires joining two tables. We'll load\nin some IMDB data:\n\n::: {#1789151f .cell execution_count=21}\n``` {.python .cell-code}\nimdb_title_basics = ibis.examples.imdb_title_basics.fetch()  # <1>\nimdb_title_basics\n```\n\n::: {.cell-output .cell-output-display execution_count=21}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┓\n┃<span style=\"font-weight: bold\"> tconst    </span>┃<span style=\"font-weight: bold\"> titleType </span>┃<span style=\"font-weight: bold\"> primaryTitle           </span>┃<span style=\"font-weight: bold\"> originalTitle          </span>┃<span style=\"font-weight: bold\"> isAdult </span>┃<span style=\"font-weight: bold\"> startYear </span>┃<span style=\"font-weight: bold\"> endYear </span>┃<span style=\"font-weight: bold\"> runtimeMinutes </span>┃<span style=\"font-weight: bold\"> genres                   </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>   │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>     │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                   │\n├───────────┼───────────┼────────────────────────┼────────────────────────┼─────────┼───────────┼─────────┼────────────────┼──────────────────────────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000001</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">short    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Carmencita            </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Carmencita            </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1894</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>    │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Documentary,Short       </span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000002</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">short    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Le clown et ses chiens</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Le clown et ses chiens</span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1892</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>    │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">5</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Animation,Short         </span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000003</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">short    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Pauvre Pierrot        </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Pauvre Pierrot        </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1892</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>    │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Animation,Comedy,Romance</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000004</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">short    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Un bon bock           </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Un bon bock           </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1892</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>    │             <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">12</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Animation,Short         </span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000005</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">short    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Blacksmith Scene      </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Blacksmith Scene      </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1893</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>    │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Comedy,Short            </span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000006</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">short    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Chinese Opium Den     </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Chinese Opium Den     </span> │       <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1894</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>    │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Short                   </span> │\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>                      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>                      │       <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>       │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>                        │\n└───────────┴───────────┴────────────────────────┴────────────────────────┴─────────┴───────────┴─────────┴────────────────┴──────────────────────────┘\n</pre>\n```\n:::\n:::\n\n\n1. Load the IMDB title basics dataset from Ibis examples\n\n::: {#50578e07 .cell execution_count=22}\n``` {.python .cell-code}\nimdb_title_ratings = ibis.examples.imdb_title_ratings.fetch()  # <1>\nimdb_title_ratings\n```\n\n::: {.cell-output .cell-output-display execution_count=22}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━┓\n┃<span style=\"font-weight: bold\"> tconst    </span>┃<span style=\"font-weight: bold\"> averageRating </span>┃<span style=\"font-weight: bold\"> numVotes </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>    │\n├───────────┼───────────────┼──────────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000001</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">5.7</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1990</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000002</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">5.8</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">265</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000003</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6.5</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1869</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000004</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">5.5</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">177</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000005</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6.2</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2655</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">tt0000006</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">5.0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">182</span> │\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>         │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │\n└───────────┴───────────────┴──────────┘\n</pre>\n```\n:::\n:::\n\n\n1. Load the IMDB title ratings dataset from Ibis examples\n\n::: {#13e0b19f .cell execution_count=23}\n``` {.python .cell-code}\ntext = \"the highest rated movies w/ over 100k ratings -- movies only\"  # <1>\n\ntable_names = [\"imdb_title_basics\", \"imdb_title_ratings\"]  # <2>\ntable_schemas = [\n    str(imdb_title_basics.schema()),\n    str(imdb_title_ratings.schema()),\n]\ntable_previews = [\n    str(imdb_title_basics.limit(5)),\n    str(imdb_title_ratings.limit(5)),\n]  # <2>\n\nsql = text_to_sql(text, table_names, table_schemas, table_previews)  # <3>\nprint(sql)\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"></pre>\n```\n:::\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"></pre>\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nSELECT t.titleType, t.primaryTitle, r.averageRating\nFROM imdb_title_basics t\nJOIN imdb_title_ratings r ON t.tconst = r.tconst\nWHERE t.titleType = 'movie'\nAND r.numVotes > 100000\nORDER BY r.averageRating DESC\nLIMIT 10\n```\n:::\n:::\n\n\n1. Create a natural language query\n2. Provide the table names, schemas, and previews\n3. Generate the SQL string\n\n::: {#dd3f3ec7 .cell execution_count=24}\n``` {.python .cell-code}\nr = imdb_title_basics.sql(sql) # <1>\nr\n```\n\n::: {.cell-output .cell-output-display execution_count=24}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓\n┃<span style=\"font-weight: bold\"> titleType </span>┃<span style=\"font-weight: bold\"> primaryTitle             </span>┃<span style=\"font-weight: bold\"> averageRating </span>┃\n┡━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                   │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │\n├───────────┼──────────────────────────┼───────────────┤\n│ <span style=\"color: #008000; text-decoration-color: #008000\">movie    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">The Shawshank Redemption</span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">9.3</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">movie    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">The Godfather           </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">9.2</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">movie    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">The Dark Knight         </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">9.0</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">movie    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">12 Angry Men            </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">9.0</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">movie    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">The Godfather Part II   </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">9.0</span> │\n│ <span style=\"color: #008000; text-decoration-color: #008000\">movie    </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">Schindler's List        </span> │           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">9.0</span> │\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span>                        │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">…</span> │\n└───────────┴──────────────────────────┴───────────────┘\n</pre>\n```\n:::\n:::\n\n\n1. Execute the SQL string on the table\n\n## Issues with language models today\n\nThe biggest model with language models today is the cost. Similarly, the time\nfor inferencing these models is the second biggest concern. Generating millions\nof synthetic data points with state-of-the-art LLMs is prohibitively expensive\nand slow.\n\nSmaller open source language models can reduce this cost to practically zero,\nbut at the expensive of quality. And generating synthetic data is likely even\nslower.\n\n## Looking forward\n\nIn a future post, we'll explore using open source language models on a laptop to\nachieve similar results. In general, I expect language models with data to\nbecome increasingly commonplace. Some predictions:\n\n- small, specialized language models will become common\n- large language models that require expensive GPU clusters will still be the\n best for general-purpose tasks\n- data assistants will be gimmicky for a while, but will eventually become\n useful\n\nKeep an eye out for our own gimmicky data assistant soon...\n\n## Conclusion\n\nTo summarize:\n\n::: {#bbf6b8fc .cell execution_count=25}\n``` {.python .cell-code}\nfrom rich import print\n\nwith open(\"index.qmd\", \"r\") as f:\n    blog_text = f.read()\n\n\nclass BlogSummary(BaseModel):\n    \"\"\"Summarizes a blog post\"\"\"\n\n    key_points: list[str] = Field(..., description=\"The key points of the blog post\")\n    one_paragraph_summary: str = Field(\n        ..., description=\"A one paragraph summary of the blog post\"\n    )\n    one_sentence_summary: str = Field(\n        ..., description=\"A one sentence summary of the blog post\"\n    )\n\n\nsummary = marvin.cast(\n    blog_text,\n    target=BlogSummary,\n)\nprint(summary)\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"color: #800080; text-decoration-color: #800080; font-weight: bold\">BlogSummary</span><span style=\"font-weight: bold\">(</span>\n    <span style=\"color: #808000; text-decoration-color: #808000\">key_points</span>=<span style=\"font-weight: bold\">[</span>\n        <span style=\"color: #008000; text-decoration-color: #008000\">'Language models can generate synthetic data, process natural language, and write code.'</span>,\n        <span style=\"color: #008000; text-decoration-color: #008000\">'They can simplify tasks for data engineers, analysts, and scientists.'</span>,\n        <span style=\"color: #008000; text-decoration-color: #008000\">'Cost and inference time are current issues with language models.'</span>\n    <span style=\"font-weight: bold\">]</span>,\n    <span style=\"color: #808000; text-decoration-color: #808000\">one_paragraph_summary</span>=<span style=\"color: #008000; text-decoration-color: #008000\">'The blog post discusses the integration of language models into data workflows, </span>\n<span style=\"color: #008000; text-decoration-color: #008000\">highlighting their use in synthetic data generation, natural language processing, and writing analytic code. It </span>\n<span style=\"color: #008000; text-decoration-color: #008000\">demonstrates these capabilities using Marvin and Ibis, and addresses the current limitations of language models, </span>\n<span style=\"color: #008000; text-decoration-color: #008000\">such as cost and inference time. The post also hints at future developments, including the use of open source </span>\n<span style=\"color: #008000; text-decoration-color: #008000\">models to reduce costs.'</span>,\n    <span style=\"color: #808000; text-decoration-color: #808000\">one_sentence_summary</span>=<span style=\"color: #008000; text-decoration-color: #008000\">'Language models are powerful tools for data practitioners, enabling synthetic data </span>\n<span style=\"color: #008000; text-decoration-color: #008000\">creation, natural language processing, and code generation, despite their cost and speed limitations.'</span>\n<span style=\"font-weight: bold\">)</span>\n</pre>\n```\n:::\n:::\n\n\nTo generate a thumbnail from the text:\n\n::: {#dd548ab7 .cell execution_count=26}\n``` {.python .cell-code}\nimport os\nimport httpx\n\nif not os.path.exists(\"thumbnail.png\"):\n\n    key_points = \"\\n - \".join(summary.key_points)\n    thumbnail = marvin.paint(\n        f\"\"\"Create a beautiful (dark background) thumbnail for the blog post with the following key points:\n\n        {key_points}\n\n        The post is about {summary.one_sentence_summary}\n\n        A one paragraph summary:\n\n        {summary.one_paragraph_summary}\n        \"\"\"\n    )\n\n    image = httpx.get(thumbnail.data[0].url)\n    with open(\"thumbnail.png\", \"wb\") as f:\n        f.write(image.content)\n```\n:::\n\n\n::: {#f696afd2 .cell execution_count=27}\n``` {.python .cell-code}\n# show the image\nimport matplotlib.pyplot as plt\n\nimg = plt.imread(\"thumbnail.png\")\nplt.imshow(img)\n```\n\n::: {.cell-output .cell-output-display}\n![](index_files/figure-html/cell-28-output-1.png){width=440 height=416}\n:::\n:::\n\n\n## Next steps\n\nTry this out yourself! All you need is an OpenAI account and the code above.\n\nIt's never been a better time to get involved with Ibis. [Join us on Zulip and\nintroduce yourself!](https://ibis-project.zulipchat.com/) More Ibis + language\nmodel content coming soon...\n\n",
    "supporting": [
      "index_files/figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n<script src=\"https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js\" crossorigin=\"anonymous\"></script>\n"
      ],
      "include-after-body": [
        "<script type=application/vnd.jupyter.widget-state+json>\n{\"state\":{\"45d075fb30a0480b89a5718f3574acb5\":{\"model_module\":\"@jupyter-widgets/controls\",\"model_module_version\":\"2.0.0\",\"model_name\":\"FloatProgressModel\",\"state\":{\"_dom_classes\":[],\"_model_module\":\"@jupyter-widgets/controls\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"FloatProgressModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/controls\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"ProgressView\",\"bar_style\":\"\",\"description\":\"\",\"description_allow_html\":false,\"layout\":\"IPY_MODEL_b703bc05478d4e01861140a17d3c1c98\",\"max\":100,\"min\":0,\"orientation\":\"horizontal\",\"style\":\"IPY_MODEL_7e74a369c5ec44029cb9a2822fa93acb\",\"tabbable\":null,\"tooltip\":null,\"value\":100}},\"7e74a369c5ec44029cb9a2822fa93acb\":{\"model_module\":\"@jupyter-widgets/controls\",\"model_module_version\":\"2.0.0\",\"model_name\":\"ProgressStyleModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/controls\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"ProgressStyleModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"StyleView\",\"bar_color\":\"black\",\"description_width\":\"\"}},\"8185f6254a0c47e585fca4491c487b07\":{\"model_module\":\"@jupyter-widgets/controls\",\"model_module_version\":\"2.0.0\",\"model_name\":\"ProgressStyleModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/controls\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"ProgressStyleModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"StyleView\",\"bar_color\":\"black\",\"description_width\":\"\"}},\"93bfcde4f20b495eaa3c5a51975e1874\":{\"model_module\":\"@jupyter-widgets/base\",\"model_module_version\":\"2.0.0\",\"model_name\":\"LayoutModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/base\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"LayoutModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"LayoutView\",\"align_content\":null,\"align_items\":null,\"align_self\":null,\"border_bottom\":null,\"border_left\":null,\"border_right\":null,\"border_top\":null,\"bottom\":null,\"display\":null,\"flex\":null,\"flex_flow\":null,\"grid_area\":null,\"grid_auto_columns\":null,\"grid_auto_flow\":null,\"grid_auto_rows\":null,\"grid_column\":null,\"grid_gap\":null,\"grid_row\":null,\"grid_template_areas\":null,\"grid_template_columns\":null,\"grid_template_rows\":null,\"height\":null,\"justify_content\":null,\"justify_items\":null,\"left\":null,\"margin\":null,\"max_height\":null,\"max_width\":null,\"min_height\":null,\"min_width\":null,\"object_fit\":null,\"object_position\":null,\"order\":null,\"overflow\":null,\"padding\":null,\"right\":null,\"top\":null,\"visibility\":null,\"width\":\"auto\"}},\"9bbe5607bfc04cf5a8005e5832f97d1d\":{\"model_module\":\"@jupyter-widgets/base\",\"model_module_version\":\"2.0.0\",\"model_name\":\"LayoutModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/base\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"LayoutModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"LayoutView\",\"align_content\":null,\"align_items\":null,\"align_self\":null,\"border_bottom\":null,\"border_left\":null,\"border_right\":null,\"border_top\":null,\"bottom\":null,\"display\":null,\"flex\":null,\"flex_flow\":null,\"grid_area\":null,\"grid_auto_columns\":null,\"grid_auto_flow\":null,\"grid_auto_rows\":null,\"grid_column\":null,\"grid_gap\":null,\"grid_row\":null,\"grid_template_areas\":null,\"grid_template_columns\":null,\"grid_template_rows\":null,\"height\":null,\"justify_content\":null,\"justify_items\":null,\"left\":null,\"margin\":null,\"max_height\":null,\"max_width\":null,\"min_height\":null,\"min_width\":null,\"object_fit\":null,\"object_position\":null,\"order\":null,\"overflow\":null,\"padding\":null,\"right\":null,\"top\":null,\"visibility\":null,\"width\":\"auto\"}},\"9c3a16cee64047d38977ad2e15bfd76d\":{\"model_module\":\"@jupyter-widgets/controls\",\"model_module_version\":\"2.0.0\",\"model_name\":\"ProgressStyleModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/controls\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"ProgressStyleModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"StyleView\",\"bar_color\":\"black\",\"description_width\":\"\"}},\"b703bc05478d4e01861140a17d3c1c98\":{\"model_module\":\"@jupyter-widgets/base\",\"model_module_version\":\"2.0.0\",\"model_name\":\"LayoutModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/base\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"LayoutModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"LayoutView\",\"align_content\":null,\"align_items\":null,\"align_self\":null,\"border_bottom\":null,\"border_left\":null,\"border_right\":null,\"border_top\":null,\"bottom\":null,\"display\":null,\"flex\":null,\"flex_flow\":null,\"grid_area\":null,\"grid_auto_columns\":null,\"grid_auto_flow\":null,\"grid_auto_rows\":null,\"grid_column\":null,\"grid_gap\":null,\"grid_row\":null,\"grid_template_areas\":null,\"grid_template_columns\":null,\"grid_template_rows\":null,\"height\":null,\"justify_content\":null,\"justify_items\":null,\"left\":null,\"margin\":null,\"max_height\":null,\"max_width\":null,\"min_height\":null,\"min_width\":null,\"object_fit\":null,\"object_position\":null,\"order\":null,\"overflow\":null,\"padding\":null,\"right\":null,\"top\":null,\"visibility\":null,\"width\":\"auto\"}},\"c670fac3882547ebbf7cb74a1e47da0e\":{\"model_module\":\"@jupyter-widgets/controls\",\"model_module_version\":\"2.0.0\",\"model_name\":\"FloatProgressModel\",\"state\":{\"_dom_classes\":[],\"_model_module\":\"@jupyter-widgets/controls\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"FloatProgressModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/controls\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"ProgressView\",\"bar_style\":\"\",\"description\":\"\",\"description_allow_html\":false,\"layout\":\"IPY_MODEL_9bbe5607bfc04cf5a8005e5832f97d1d\",\"max\":100,\"min\":0,\"orientation\":\"horizontal\",\"style\":\"IPY_MODEL_9c3a16cee64047d38977ad2e15bfd76d\",\"tabbable\":null,\"tooltip\":null,\"value\":100}},\"c8577fa601dc4f309d254613821ed75b\":{\"model_module\":\"@jupyter-widgets/controls\",\"model_module_version\":\"2.0.0\",\"model_name\":\"FloatProgressModel\",\"state\":{\"_dom_classes\":[],\"_model_module\":\"@jupyter-widgets/controls\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"FloatProgressModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/controls\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"ProgressView\",\"bar_style\":\"\",\"description\":\"\",\"description_allow_html\":false,\"layout\":\"IPY_MODEL_f6204b32d9db4a629b9905f226d18812\",\"max\":100,\"min\":0,\"orientation\":\"horizontal\",\"style\":\"IPY_MODEL_8185f6254a0c47e585fca4491c487b07\",\"tabbable\":null,\"tooltip\":null,\"value\":100}},\"cee2ed4e75204098858d51665f93db30\":{\"model_module\":\"@jupyter-widgets/controls\",\"model_module_version\":\"2.0.0\",\"model_name\":\"FloatProgressModel\",\"state\":{\"_dom_classes\":[],\"_model_module\":\"@jupyter-widgets/controls\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"FloatProgressModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/controls\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"ProgressView\",\"bar_style\":\"\",\"description\":\"\",\"description_allow_html\":false,\"layout\":\"IPY_MODEL_93bfcde4f20b495eaa3c5a51975e1874\",\"max\":100,\"min\":0,\"orientation\":\"horizontal\",\"style\":\"IPY_MODEL_db87a7eef9134bb086277f74df4a91c4\",\"tabbable\":null,\"tooltip\":null,\"value\":100}},\"db87a7eef9134bb086277f74df4a91c4\":{\"model_module\":\"@jupyter-widgets/controls\",\"model_module_version\":\"2.0.0\",\"model_name\":\"ProgressStyleModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/controls\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"ProgressStyleModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"StyleView\",\"bar_color\":\"black\",\"description_width\":\"\"}},\"f6204b32d9db4a629b9905f226d18812\":{\"model_module\":\"@jupyter-widgets/base\",\"model_module_version\":\"2.0.0\",\"model_name\":\"LayoutModel\",\"state\":{\"_model_module\":\"@jupyter-widgets/base\",\"_model_module_version\":\"2.0.0\",\"_model_name\":\"LayoutModel\",\"_view_count\":null,\"_view_module\":\"@jupyter-widgets/base\",\"_view_module_version\":\"2.0.0\",\"_view_name\":\"LayoutView\",\"align_content\":null,\"align_items\":null,\"align_self\":null,\"border_bottom\":null,\"border_left\":null,\"border_right\":null,\"border_top\":null,\"bottom\":null,\"display\":null,\"flex\":null,\"flex_flow\":null,\"grid_area\":null,\"grid_auto_columns\":null,\"grid_auto_flow\":null,\"grid_auto_rows\":null,\"grid_column\":null,\"grid_gap\":null,\"grid_row\":null,\"grid_template_areas\":null,\"grid_template_columns\":null,\"grid_template_rows\":null,\"height\":null,\"justify_content\":null,\"justify_items\":null,\"left\":null,\"margin\":null,\"max_height\":null,\"max_width\":null,\"min_height\":null,\"min_width\":null,\"object_fit\":null,\"object_position\":null,\"order\":null,\"overflow\":null,\"padding\":null,\"right\":null,\"top\":null,\"visibility\":null,\"width\":\"auto\"}}},\"version_major\":2,\"version_minor\":0}\n</script>\n"
      ]
    }
  }
}