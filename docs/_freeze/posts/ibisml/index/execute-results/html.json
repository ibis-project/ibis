{
  "hash": "e8b0170e7a65991425092177c91b8c49",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Using IbisML for a kagge competition: credit risk model stability\" \nauthor: \"Jiting Xu\"\ndate: \"2024-07-02\"\ncategories:\n    - blog\n    - machine learning\n    - feature engineering \nexecute:\n    freeze: auto\n---\n\n## Introduction\nIn this post, we'll demonstrate how to use Ibis and IbisML end-to-end for a Kaggle competition - [Credit risk model stability](https://www.kaggle.com/competitions/home-credit-credit-risk-model-stability)\n\n1. Load data and perform feature engineering with Ibis on a duckdb backend \n2. Conduct last-mile ML data preprocessing with IbisML\n3. Train two models using different frameworks:\n    * Neural network with PyTorch and PyTorch Lightning\n    * XGBoost\n\nThe aim of this competition is to predict which clients are more likely to default on\ntheir loans by leveraging both internal and external data sources.\n\nTo get started with Ibis and IbisML, please refer to the websites:\n\n- [Ibis](https://ibis-project.org/): An open-source dataframe library that works with any data system.\n- [IbisML](https://ibis-project.github.io/ibis-ml/): A library for building scalable ML pipelines.\n\n\n## Prerequisites\nTo run this example, you'll need to download the data from kaggle website\nwith a kaggle user account and install Ibis, IbisML, and the necessary modeling library.\n\n### Download data \nYou need a kaggle account to download the data. If you donot have one,\nfeel free to register one. \n\n1. Option 1: Mannual Download\n     - Log into your kaggle account and download all data from this [link](https://www.kaggle.com/competitions/home-credit-credit-risk-model-stability/data), unzip the files, and save them to your local disk.\n2. Option 2: Kaggle API\n    - Go to your Kaggle account settings: [Kaggle Account Settings](https://www.kaggle.com/account).\n    - Under the \"API\" section, click on \"Create New API Token\". This will download the `kaggle.json` file to your computer.\n    - Place the `kaggle.json` file in the correct directory, normally it is under your home directory `~/.kaggle`:\n        \n        ```bash\n        mkdir ~/.kaggle\n        mv ~/Downloads/kaggle.json ~/.kaggle\n        ```\n    - Install Kaggle CLI and download the data:\n        \n        ```bash\n        pip install kaggle\n        kaggle competitions download -c home-credit-credit-risk-model-stability\n        unzip home-credit-credit-risk-model-stability.zip\n        ```\n\n\n\n### Install libraries\nTo use Ibis and IbisML with the DuckDB backend, you'll need to install the necessary packages: \n\n```python\npip install 'ibis-framework[duckdb]' ibis-ml\n```\n\nWhen building models, ensure you have the required libraries installed:\n\n```python\n# PyTorch\npip install torch torchvision pytorch-lightning\n\n# XGBoost\npip install xgboost\n```\n\n## Data loading and processing \nWe'll use Ibis to read the parquet files (with the same data also available\nin CSV format) and perform the necessary processing for the next step.\n\n::: {.callout-tip}\nYou can perform the same process with a different backend, such as\nPolars, Dask, BigQuery, Spark, or other Ibis-supported backends. Move the datasets to the\ndesired database and set the Ibis backend using the reference: [Work with multiple\nbackends](https://ibis-project.org/how-to/input-output/multiple-backends). \n:::\n\n### Directory structure and tables\nSince there are many data files, let's start by examining the directory\nstructure and tables within the train directory:\n\n```bash\n# Change this to your directory\ntree -L 2 /Users/claypot/Downloads/home-credit-credit-risk-model-stability/parquet_files/train\n```\n\nThe output will show:\n\n```bash\n/Users/claypot/Downloads/home-credit-credit-risk-model-stability/parquet_files/train \n├── train_applprev_1_0.parquet \n├── train_applprev_1_1.parquet\n├── train_applprev_2.parquet\n├── train_base.parquet\n├── train_credit_bureau_a_1_0.parquet\n├── train_credit_bureau_a_1_1.parquet\n├── train_credit_bureau_a_1_3.parquet\n├── train_credit_bureau_a_2_0.parquet\n├── train_credit_bureau_a_2_1.parquet\n├── train_credit_bureau_a_2_10.parquet\n├── train_credit_bureau_a_2_2.parquet\n├── train_credit_bureau_a_2_3.parquet\n├── train_credit_bureau_a_2_4.parquet\n├── train_credit_bureau_a_2_5.parquet \n├── train_credit_bureau_a_2_6.parquet\n├── train_credit_bureau_a_2_7.parquet\n├── train_credit_bureau_a_2_8.parquet\n├── train_credit_bureau_a_2_9.parquet\n├── train_credit_bureau_b_1.parquet\n├── train_credit_bureau_b_2.parquet \n├── train_debitcard_1.parquet \n├── train_deposit_1.parquet\n├── train_other_1.parquet \n├── train_person_1.parquet \n├── train_person_2.parquet \n├── train_static_0_0.parquet \n├── train_static_0_1.parquet \n├── train_static_cb_0.parquet \n├── train_tax_registry_a_1.parquet \n├── train_tax_registry_b_1.parquet \n└── train_tax_registry_c_1.parquet\n``` \nThe `train_base.parquet` file is the base table, while\nthe others are feature tables. Let's take a quick look at these tables.\n\n#### Base table\nThe base table (`train_base.parquet`) contains the unique id, a binary\ntarget flag and other information for the training samples. This unique ID will serve as\nthe linking key for joining with other feature tables.\n\n- `case_id` - This is the unique identifier for each loan case. You'll need this ID to\n  join feature tables to the base table. There are about 1.5m unique loans.\n- `date_decision` - This refers to the date when a decision was made regarding the\n  approval of the loan.\n- `WEEK_NUM` - This is the week number used for aggregation.\n- `MONTH` - This column represents the month when the approval decision was made.\n- `target` - This is the binary target flag, determined after a certain period based on\n  whether or not the client defaulted on the specific loan.\n\n#### Feature tables\n\nThe remaining files contain feature data, consisting of approximately 450 unique features\nfrom previous loan applications and external data sources.  Their definitions can be found\nin the file `feature_definitions.csv` from the competition website\n[link](https://www.kaggle.com/competitions/home-credit-credit-risk-model-stability/data).\n\n::: {.callout-note} \nThere are several things we want to mention: \n\n1. **Union datasets**: One dataset could be saved into multiple parquet files, such as\n`train_applprev_1_0.parquet` and `train_applprev_1_1.parquet`, We need to union this data.\n2. **Dataset levels**: Datasets may have different levels, which we will explain as\nfollows:\n     - **Depth = 0**: For depth = 0 tables, features can be directly joined with the base\n       table and used as features.\n     - **Depth > 0**: For depth > 0 tables, it requires aggregation using `case_id`,\n       which will collect the statistics for each loan. \n:::\n\nHere are several examples of tables with different levels.\n\n::: {#f9b3bc70 .cell execution_count=1}\n``` {.python .cell-code}\n# Import libraries\nimport ibis \nimport ibis.expr.datatypes as dt \nfrom ibis import _\nimport ibis_ml as ml\nfrom pathlib import Path\nfrom glob import glob\n\n# enable interactive mode for ibis\nibis.options.interactive = True\n```\n:::\n\n\n::: {#6c7484a1 .cell execution_count=2}\n``` {.python .cell-code}\n# Change the root path to yours\nROOT       = Path(\"/Users/claypot/Downloads/home-credit-credit-risk-model-stability\")\nTRAIN_DIR  = ROOT / \"parquet_files\" / \"train\" \nTEST_DIR   = ROOT /\"parquet_files\" / \"test\" \n```\n:::\n\n\n::: {#984ce988 .cell execution_count=3}\n``` {.python .cell-code}\n# Example of table with depth = 0 Features can be directly joined with the base table.\nibis.read_parquet(TRAIN_DIR / \"train_static_cb_0.parquet\").head()\n```\n\n::: {.cell-output .cell-output-display execution_count=75}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┓\n┃<span style=\"font-weight: bold\"> case_id </span>┃<span style=\"font-weight: bold\"> assignmentdate_238D </span>┃<span style=\"font-weight: bold\"> assignmentdate_4527235D </span>┃<span style=\"font-weight: bold\"> assignmentdate_4955616D </span>┃<span style=\"font-weight: bold\"> birthdate_574D </span>┃<span style=\"font-weight: bold\"> contractssum_5085716L </span>┃<span style=\"font-weight: bold\"> dateofbirth_337D </span>┃<span style=\"font-weight: bold\"> dateofbirth_342D </span>┃<span style=\"font-weight: bold\"> days120_123L </span>┃<span style=\"font-weight: bold\"> days180_256L </span>┃<span style=\"font-weight: bold\"> days30_165L </span>┃<span style=\"font-weight: bold\"> days360_512L </span>┃<span style=\"font-weight: bold\"> days90_310L </span>┃<span style=\"font-weight: bold\"> description_5085714M </span>┃<span style=\"font-weight: bold\"> education_1103M </span>┃<span style=\"font-weight: bold\"> education_88M </span>┃<span style=\"font-weight: bold\"> firstquarter_103L </span>┃<span style=\"font-weight: bold\"> for3years_128L </span>┃<span style=\"font-weight: bold\"> for3years_504L </span>┃<span style=\"font-weight: bold\"> for3years_584L </span>┃<span style=\"font-weight: bold\"> formonth_118L </span>┃<span style=\"font-weight: bold\"> formonth_206L </span>┃<span style=\"font-weight: bold\"> formonth_535L </span>┃<span style=\"font-weight: bold\"> forquarter_1017L </span>┃<span style=\"font-weight: bold\"> forquarter_462L </span>┃<span style=\"font-weight: bold\"> forquarter_634L </span>┃<span style=\"font-weight: bold\"> fortoday_1092L </span>┃<span style=\"font-weight: bold\"> forweek_1077L </span>┃<span style=\"font-weight: bold\"> forweek_528L </span>┃<span style=\"font-weight: bold\"> forweek_601L </span>┃<span style=\"font-weight: bold\"> foryear_618L </span>┃<span style=\"font-weight: bold\"> foryear_818L </span>┃<span style=\"font-weight: bold\"> foryear_850L </span>┃<span style=\"font-weight: bold\"> fourthquarter_440L </span>┃<span style=\"font-weight: bold\"> maritalst_385M </span>┃<span style=\"font-weight: bold\"> maritalst_893M </span>┃<span style=\"font-weight: bold\"> numberofqueries_373L </span>┃<span style=\"font-weight: bold\"> pmtaverage_3A </span>┃<span style=\"font-weight: bold\"> pmtaverage_4527227A </span>┃<span style=\"font-weight: bold\"> pmtaverage_4955615A </span>┃<span style=\"font-weight: bold\"> pmtcount_4527229L </span>┃<span style=\"font-weight: bold\"> pmtcount_4955617L </span>┃<span style=\"font-weight: bold\"> pmtcount_693L </span>┃<span style=\"font-weight: bold\"> pmtscount_423L </span>┃<span style=\"font-weight: bold\"> pmtssum_45A </span>┃<span style=\"font-weight: bold\"> requesttype_4525192L </span>┃<span style=\"font-weight: bold\"> responsedate_1012D </span>┃<span style=\"font-weight: bold\"> responsedate_4527233D </span>┃<span style=\"font-weight: bold\"> responsedate_4917613D </span>┃<span style=\"font-weight: bold\"> riskassesment_302T </span>┃<span style=\"font-weight: bold\"> riskassesment_940T </span>┃<span style=\"font-weight: bold\"> secondquarter_766L </span>┃<span style=\"font-weight: bold\"> thirdquarter_1082L </span>┃\n┡━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>   │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>              │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>               │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>           │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>           │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>     │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>     │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>               │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>           │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>            │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>              │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>           │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>           │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>     │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>               │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>            │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>            │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>            │\n├─────────┼─────────────────────┼─────────────────────────┼─────────────────────────┼────────────────┼───────────────────────┼──────────────────┼──────────────────┼──────────────┼──────────────┼─────────────┼──────────────┼─────────────┼──────────────────────┼─────────────────┼───────────────┼───────────────────┼────────────────┼────────────────┼────────────────┼───────────────┼───────────────┼───────────────┼──────────────────┼─────────────────┼─────────────────┼────────────────┼───────────────┼──────────────┼──────────────┼──────────────┼──────────────┼──────────────┼────────────────────┼────────────────┼────────────────┼──────────────────────┼───────────────┼─────────────────────┼─────────────────────┼───────────────────┼───────────────────┼───────────────┼────────────────┼─────────────┼──────────────────────┼────────────────────┼───────────────────────┼───────────────────────┼────────────────────┼────────────────────┼────────────────────┼────────────────────┤\n│     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">357</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #008000; text-decoration-color: #008000\">1988-04-01    </span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>             │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1            </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1     </span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6.0</span> │   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6301.4000</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                 │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-25        </span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>               │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │\n│     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">381</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #008000; text-decoration-color: #008000\">1973-11-01    </span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>             │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1            </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1     </span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6.0</span> │   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4019.6000</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                 │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-25        </span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>               │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │\n│     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">388</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #008000; text-decoration-color: #008000\">1989-04-01    </span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">1989-04-01      </span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>             │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">8.0</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2.0</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10.0</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1            </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1     </span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2.0</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │                 <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10.0</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6.0</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">14548.0000</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                 │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-28        </span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>               │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.0</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">5.0</span> │\n│     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">405</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #008000; text-decoration-color: #008000\">1974-03-01    </span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">1974-03-01      </span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>             │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.0</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1            </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1     </span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.0</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6.0</span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10498.2400</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                 │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-21        </span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>               │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2.0</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │\n│     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">409</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                    │ <span style=\"color: #008000; text-decoration-color: #008000\">1993-06-01    </span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">1993-06-01      </span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>             │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.0</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.0</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1            </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">717ddd49       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1     </span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4.0</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a7fcb6e5      </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.0</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │            <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">7.0</span> │   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">6344.8804</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                 │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-21        </span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>               │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4.0</span> │\n└─────────┴─────────────────────┴─────────────────────────┴─────────────────────────┴────────────────┴───────────────────────┴──────────────────┴──────────────────┴──────────────┴──────────────┴─────────────┴──────────────┴─────────────┴──────────────────────┴─────────────────┴───────────────┴───────────────────┴────────────────┴────────────────┴────────────────┴───────────────┴───────────────┴───────────────┴──────────────────┴─────────────────┴─────────────────┴────────────────┴───────────────┴──────────────┴──────────────┴──────────────┴──────────────┴──────────────┴────────────────────┴────────────────┴────────────────┴──────────────────────┴───────────────┴─────────────────────┴─────────────────────┴───────────────────┴───────────────────┴───────────────┴────────────────┴─────────────┴──────────────────────┴────────────────────┴───────────────────────┴───────────────────────┴────────────────────┴────────────────────┴────────────────────┴────────────────────┘\n</pre>\n```\n:::\n:::\n\n\n::: {#9d493224 .cell execution_count=4}\n``` {.python .cell-code}\n# Example of a table with depth = 1 We need to aggregate the features and collect\n# statistics based on `case_id` and then join with the base table to use them as features\nibis.read_parquet(TRAIN_DIR /\n\"train_credit_bureau_b_1.parquet\").relocate(\"num_group1\").order_by([\"case_id\", \"num_group1\"]).head()\n```\n\n::: {.cell-output .cell-output-display execution_count=76}\n```{=html}\n<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">┏━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┓\n┃<span style=\"font-weight: bold\"> num_group1 </span>┃<span style=\"font-weight: bold\"> case_id </span>┃<span style=\"font-weight: bold\"> amount_1115A </span>┃<span style=\"font-weight: bold\"> classificationofcontr_1114M </span>┃<span style=\"font-weight: bold\"> contractdate_551D </span>┃<span style=\"font-weight: bold\"> contractmaturitydate_151D </span>┃<span style=\"font-weight: bold\"> contractst_516M </span>┃<span style=\"font-weight: bold\"> contracttype_653M </span>┃<span style=\"font-weight: bold\"> credlmt_1052A </span>┃<span style=\"font-weight: bold\"> credlmt_228A </span>┃<span style=\"font-weight: bold\"> credlmt_3940954A </span>┃<span style=\"font-weight: bold\"> credor_3940957M </span>┃<span style=\"font-weight: bold\"> credquantity_1099L </span>┃<span style=\"font-weight: bold\"> credquantity_984L </span>┃<span style=\"font-weight: bold\"> debtpastduevalue_732A </span>┃<span style=\"font-weight: bold\"> debtvalue_227A </span>┃<span style=\"font-weight: bold\"> dpd_550P </span>┃<span style=\"font-weight: bold\"> dpd_733P </span>┃<span style=\"font-weight: bold\"> dpdmax_851P </span>┃<span style=\"font-weight: bold\"> dpdmaxdatemonth_804T </span>┃<span style=\"font-weight: bold\"> dpdmaxdateyear_742T </span>┃<span style=\"font-weight: bold\"> installmentamount_644A </span>┃<span style=\"font-weight: bold\"> installmentamount_833A </span>┃<span style=\"font-weight: bold\"> instlamount_892A </span>┃<span style=\"font-weight: bold\"> interesteffectiverate_369L </span>┃<span style=\"font-weight: bold\"> interestrateyearly_538L </span>┃<span style=\"font-weight: bold\"> lastupdate_260D </span>┃<span style=\"font-weight: bold\"> maxdebtpduevalodued_3940955A </span>┃<span style=\"font-weight: bold\"> numberofinstls_810L </span>┃<span style=\"font-weight: bold\"> overdueamountmax_950A </span>┃<span style=\"font-weight: bold\"> overdueamountmaxdatemonth_494T </span>┃<span style=\"font-weight: bold\"> overdueamountmaxdateyear_432T </span>┃<span style=\"font-weight: bold\"> periodicityofpmts_997L </span>┃<span style=\"font-weight: bold\"> periodicityofpmts_997M </span>┃<span style=\"font-weight: bold\"> pmtdaysoverdue_1135P </span>┃<span style=\"font-weight: bold\"> pmtmethod_731M </span>┃<span style=\"font-weight: bold\"> pmtnumpending_403L </span>┃<span style=\"font-weight: bold\"> purposeofcred_722M </span>┃<span style=\"font-weight: bold\"> residualamount_1093A </span>┃<span style=\"font-weight: bold\"> residualamount_127A </span>┃<span style=\"font-weight: bold\"> residualamount_3940956A </span>┃<span style=\"font-weight: bold\"> subjectrole_326M </span>┃<span style=\"font-weight: bold\"> subjectrole_43M </span>┃<span style=\"font-weight: bold\"> totalamount_503A </span>┃<span style=\"font-weight: bold\"> totalamount_881A </span>┃\n┡━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━┩\n│ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">int64</span>   │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>            │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>            │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>            │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>           │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>               │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>  │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>     │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>              │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>                │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>                    │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>                      │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>               │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>                        │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>                       │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>              │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>         │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>            │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>              │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>             │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>                 │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>           │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">string</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>          │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">float64</span>          │\n├────────────┼─────────┼──────────────┼─────────────────────────────┼───────────────────┼───────────────────────────┼─────────────────┼───────────────────┼───────────────┼──────────────┼──────────────────┼─────────────────┼────────────────────┼───────────────────┼───────────────────────┼────────────────┼──────────┼──────────┼─────────────┼──────────────────────┼─────────────────────┼────────────────────────┼────────────────────────┼──────────────────┼────────────────────────────┼─────────────────────────┼─────────────────┼──────────────────────────────┼─────────────────────┼───────────────────────┼────────────────────────────────┼───────────────────────────────┼────────────────────────┼────────────────────────┼──────────────────────┼────────────────┼────────────────────┼────────────────────┼──────────────────────┼─────────────────────┼─────────────────────────┼──────────────────┼─────────────────┼──────────────────┼──────────────────┤\n│          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">467</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ea6782cc                   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2011-06-15       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2031-06-13               </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">7241344e       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">724be82a         </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.000000e+06</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10000.0</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.000000e+06</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">P164_34_168    </span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2.0</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.0</span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.000</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                       <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-20     </span> │                         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                   │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1              </span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">96a8fdfe          </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                 <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">fa4f56f1        </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ab3c25cf       </span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.000000e+06</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10000.0</span> │\n│          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">467</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ea6782cc                   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-04       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2021-08-04               </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">7241344e       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">724be82a         </span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.303650e+05</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">P164_34_168    </span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.0</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2.0</span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">26571.969</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                       <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-20     </span> │                         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                   │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1              </span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">96a8fdfe          </span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ab3c25cf        </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ab3c25cf       </span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">7.800000e+04</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">960000.0</span> │\n│          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">467</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">78000.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ea6782cc                   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2016-10-25       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-10-25               </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">7241344e       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">4257cbed         </span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">c5a72b57       </span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │              <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">26571.969</span> │     <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │     <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                 <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">11.0</span> │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2016.0</span> │                   <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                   <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2898.76</span> │                       <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-10     </span> │                          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">36.0</span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                           <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">11.0</span> │                        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2016.0</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                   │ <span style=\"color: #008000; text-decoration-color: #008000\">a0b598e4              </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">e914c86c      </span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">10.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">96a8fdfe          </span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1        </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1       </span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │\n│          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0</span> │    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1445</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ea6782cc                   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2015-01-30       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2021-01-30               </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">7241344e       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">1c9c5356         </span> │  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4.000000e+05</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">100000.0</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">7.400000e+04</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">b619fa46       </span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2.0</span> │               <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">5.0</span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">200418.0</span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.0</span> │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2018.0</span> │                    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.000</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                       <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-19     </span> │                          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.4</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                   <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1.4</span> │                            <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2.0</span> │                        <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">2018.0</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                   │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1              </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">60c73645          </span> │                  <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                 <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">73044.18</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">daf49a8a        </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ab3c25cf       </span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4.000000e+05</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">100000.0</span> │\n│          <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span> │    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1445</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">01f63ac8                   </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2014-09-12       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2021-09-12               </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">7241344e       </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">724be82a         </span> │          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">4.000000e+05</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">74bd67a8       </span> │                <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.0</span> │              <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">17.0</span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │      <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │        <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">0.0</span> │             <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">209617.770</span> │             <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                       <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">2019-01-13     </span> │                         <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                  <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                           <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                          <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span>                   │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1              </span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">a55475b1      </span> │               <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">96a8fdfe          </span> │                 <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │                    <span style=\"color: #7f7f7f; text-decoration-color: #7f7f7f\">NULL</span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ab3c25cf        </span> │ <span style=\"color: #008000; text-decoration-color: #008000\">ab3c25cf       </span> │     <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">3.968006e+05</span> │         <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">184587.8</span> │\n└────────────┴─────────┴──────────────┴─────────────────────────────┴───────────────────┴───────────────────────────┴─────────────────┴───────────────────┴───────────────┴──────────────┴──────────────────┴─────────────────┴────────────────────┴───────────────────┴───────────────────────┴────────────────┴──────────┴──────────┴─────────────┴──────────────────────┴─────────────────────┴────────────────────────┴────────────────────────┴──────────────────┴────────────────────────────┴─────────────────────────┴─────────────────┴──────────────────────────────┴─────────────────────┴───────────────────────┴────────────────────────────────┴───────────────────────────────┴────────────────────────┴────────────────────────┴──────────────────────┴────────────────┴────────────────────┴────────────────────┴──────────────────────┴─────────────────────┴─────────────────────────┴──────────────────┴─────────────────┴──────────────────┴──────────────────┘\n</pre>\n```\n:::\n:::\n\n\nFor more details on features and its exploratory data analysis (EDA), you can refer to\nfeature dictionary and these kaggle notebooks:\n- [Feature\n  dictionary](https://www.kaggle.com/competitions/home-credit-credit-risk-model-stability/data#:~:text=calendar_view_week-,feature_definitions,-.csv)\n- [Home credit risk prediction\n  EDA](https://www.kaggle.com/code/loki97/home-credit-risk-prediction-eda)\n- [Home credit CRMS 2024\n  EDA](https://www.kaggle.com/code/sergiosaharovskiy/home-credit-crms-2024-eda-and-submission)\n\n### Data loading and processing\n\nWe will perform the following data processing steps using Ibis and IbisML:\n\n- **Convert data types**: Ensure consistency by converting data types, as the same column\n  in different sub-files may have different types.\n- **Aggregate features**: For tables with depth greater than 0, aggregate features based\n  on `case_id`, including statistics calculation. You can collect statistics such as mean,\nmedian, mode, minimum, standard deviation, and others based on your needs.\n- **Union and join datasets**: Combine multiple sub-files of the same dataset into one\n  table by appending them, as some datasets are split into multiple sub-files with a\ncommon prefix. Afterward, join these tables with the base table.\n\n#### Convert data types\n\nWe'll use IbisML to create a chain of `Cast` steps, forming a recipe for data type\nconversion across the dataset. This conversion is based on the provided information\nextracted from column names. Columns that have similar transformations are indicated by a\ncapital letter at the end of their names:\n\n- P - Transform DPD (Days past due)\n- M - Masking categories\n- A - Transform amount\n- D - Transform date\n- T - Unspecified Transform\n- L - Unspecified Transform\n\nWe'll define the\n[recipe](https://ibis-project.github.io/ibis-ml/reference/core.html#ibis_ml.Recipe) for\ndata processing, which will be used later to prepare the dataset.\n\n```python\n# Convert columns ends with P to floating number\nstep_cast_P_to_float = ml.Cast(ml.endswith(\"P\"), dt.float64)\n# Convert columns ends with A to floating number\nstep_cast_A_to_float = ml.Cast(ml.endswith(\"A\"), dt.float64)\n# Convert columns ends with D to date\nstep_cast_D_to_date = ml.Cast(ml.endswith(\"D\"), dt.date)\n# Convert columns ends with M to str\nstep_cast_M_to_str = ml.Cast(ml.endswith(\"M\"), dt.str)\n\ndata_type_recipes = ml.Recipe(\n    step_cast_P_to_float,\n    step_cast_D_to_date,\n    step_cast_M_to_str,\n    step_cast_A_to_float,\n    # Cast some special columns\n    ml.Cast([\"date_decision\"], \"date\"),\n    ml.Cast([\"case_id\", \"WEEK_NUM\", \"num_group1\", \"num_group2\"], dt.int64),\n    ml.Cast(\n        [\n            \"cardtype_51L\",\n            \"credacc_status_367L\",\n            \"requesttype_4525192L\",\n            \"riskassesment_302T\",\n            \"max_periodicityofpmts_997L\",\n        ], \n        dt.str\n    ),\n    ml.Cast(\n        [\n            \"isbidproductrequest_292L\",\n            \"isdebitcard_527L\",\n            \"equalityempfrom_62L\",\n        ],\n        dt.int64\n    ),\n)\n```\n\n::: {.callout-tip}\nIbisML offers a powerful set of column selectors, allowing you to\nselect columns based on names, types, and patterns. For more information, you can refer to\nthe IbisML column selectors\n[documentation](https://ibis-project.github.io/ibis-ml/reference/selectors.html). \n:::\n\n#### Aggregate features\n\nFor tables with a depth greater than 0 that cannot be directly joined with the base table,\nwe need to aggregate the features by the `case_id`. You could compute the minimum,\nmaximum, mean, median, and standard deviation for numeric columns, and the maximum and\nminimum for non-numeric columns.\n\nHere, I use the maximum as an example.\n\n```{python} def agg_by_id(table): return table.group_by(\"case_id\").agg( [\ntable[col_name].max().name(f\"max_{col_name}\") for col_name in table.columns if\ncol_name[-1] in (\"T\", \"L\", \"P\", \"A\", \"D\", \"M\") ])\n```\n\n#### Read and process the data files\n\nWe will define a function reads parquet files, optionally handles regex patterns for\nmultiple sub-files, applies data type transformations using `data_type_recipes`, and\nperforms aggregation based on `case_id` if specified by the depth parameter.\n\n```python\ndef read_and_process_files(file_path, depth=None, is_regex=False):\n    \"\"\"\n    Read and process Parquet files.\n    \n    Args:\n        file_path (str): Path to the file or regex pattern to match files.\n        depth (int, optional): Depth of processing. If 1 or 2, additional aggregation is performed. \n        is_regex (bool, optional): Whether the file_path is a regex pattern.\n    \n    Returns:\n        ibis.Table: The processed Ibis table.\n    \"\"\"\n    if is_regex:\n        # Read and union multiple files\n        chunks = []\n        for path in glob(str(file_path)):\n            chunk = ibis.read_parquet(path)\n            # Transform table using IbisML\n            chunk = data_type_recipes.fit(chunk).to_ibis(chunk)\n            chunks.append(chunk)\n        table = ibis.union(*chunks)\n    else:\n        # Read a single file\n        table = ibis.read_parquet(file_path)\n        # Transform table using IbisML\n        table = data_type_recipes.fit(table).to_ibis(table)\n    \n    # Perform aggregation if depth is 1 or 2\n    if depth in [1, 2]:\n        table = agg_by_id(table)\n    \n    return table\n```\n\nLet's define two dictionaries, `train_data_store` and `test_data_store`, that organize and\nstore processed datasets for training and testing.\n\n```python\ntrain_data_store = {\n    \"df_base\": read_and_process_files(TRAIN_DIR / \"train_base.parquet\"),\n    \"depth_0\": [\n        read_and_process_files(TRAIN_DIR / \"train_static_cb_0.parquet\"),\n        read_and_process_files(TRAIN_DIR / \"train_static_0_*.parquet\", is_regex=True),\n    ],\n    \"depth_1\": [\n        read_and_process_files(TRAIN_DIR / \"train_applprev_1_*.parquet\", 1, is_regex=True),\n        read_and_process_files(TRAIN_DIR / \"train_tax_registry_a_1.parquet\", 1),\n        read_and_process_files(TRAIN_DIR / \"train_tax_registry_b_1.parquet\", 1),\n        read_and_process_files(TRAIN_DIR / \"train_tax_registry_c_1.parquet\", 1),\n        read_and_process_files(TRAIN_DIR / \"train_credit_bureau_b_1.parquet\", 1),\n        read_and_process_files(TRAIN_DIR / \"train_other_1.parquet\", 1),\n        read_and_process_files(TRAIN_DIR / \"train_person_1.parquet\", 1),\n        read_and_process_files(TRAIN_DIR / \"train_deposit_1.parquet\", 1),\n        read_and_process_files(TRAIN_DIR / \"train_debitcard_1.parquet\", 1),\n    ],\n    \"depth_2\": [\n        read_and_process_files(TRAIN_DIR / \"train_credit_bureau_b_2.parquet\", 2),\n    ]\n}\n\ntest_data_store = {\n    \"df_base\": read_and_process_files(TEST_DIR / \"test_base.parquet\"),\n    \"depth_0\": [\n        read_and_process_files(TEST_DIR / \"test_static_cb_0.parquet\"),\n        read_and_process_files(TEST_DIR / \"test_static_0_*.parquet\", is_regex=True),\n    ],\n    \"depth_1\": [\n        read_and_process_files(TEST_DIR / \"test_applprev_1_*.parquet\", 1, is_regex=True),\n        read_and_process_files(TEST_DIR / \"test_tax_registry_a_1.parquet\", 1),\n        read_and_process_files(TEST_DIR / \"test_tax_registry_b_1.parquet\", 1),\n        read_and_process_files(TEST_DIR / \"test_tax_registry_c_1.parquet\", 1),\n        read_and_process_files(TEST_DIR / \"test_credit_bureau_b_1.parquet\", 1),\n        read_and_process_files(TEST_DIR / \"test_other_1.parquet\", 1),\n        read_and_process_files(TEST_DIR / \"test_person_1.parquet\", 1),\n        read_and_process_files(TEST_DIR / \"test_deposit_1.parquet\", 1),\n        read_and_process_files(TEST_DIR / \"test_debitcard_1.parquet\", 1),\n    ],\n    \"depth_2\": [\n        read_and_process_files(TEST_DIR / \"test_credit_bureau_b_2.parquet\", 2),\n    ]\n}\n```\n\nGenerate train and test datasets\n\n```python\ndef join_data(df_base, depth_0, depth_1, depth_2):\n    for i, df in enumerate(depth_0 + depth_1 + depth_2):\n        df_base = df_base.join(df, \"case_id\", how=\"left\", rname=\"{name}_right\" + f\"_{i}\" )\n    return df_base\n```\n\n#### Remove less meaningful columns\n\nTo filter out columns based on specific criteria, you can follow these steps:\n\n- Remove columns where the average proportion of null values exceeds 0.95.\n- Remove categorical columns where the number of unique values is more than 50.\n\n::: {.callout-warning}\nRunning the following code may take up to 10 minutes.  You can skip\nthis step and proceed to the next cell, where pre-identified columns are provided. \n:::\n\n```python\n# use this to find the removed_cols, it will take a couple of minutes, \n# you could directly use the output in the next cell\n# removed_cols = []\n# for colname in df_train.columns:\n# Todo(Jiting): rewrite this to make it more efficient\n# Calculate all the stats in one run?\n#     null_frac = df_train[colname].isnull().mean().execute()\n#     freq = df_train[colname].nunique().execute()\n#     if colname not in [\n#                           \"target\",\n#                           \"case_id\",\n#                           \"WEEK_NUM\"\n#                       ] and null_frac > 0.95:\n#         removed_cols.append(colname)\n#     if colname not in [\"target\", \"case_id\", \"WEEK_NUM\"] and str(df_train[colname].type()) ==  \"string\":\n#         if (freq == 1) | (freq > 50):\n#             removed_cols.append(colname)\n#     if (colname[-1] not in [\"P\", \"A\", \"L\", \"M\"]) and (('month_' in colname) or ('year_' in colname)):\n#         removed_cols.append(colname)\n```\n\n```python\nremoved_cols = [\n    'assignmentdate_4955616D',\n    'dateofbirth_342D',\n    'for3years_128L',\n    'for3years_504L',\n    'for3years_584L',\n    'formonth_118L',\n    'formonth_206L',\n    'formonth_535L',\n    'forquarter_1017L',\n    'forquarter_462L',\n    'forquarter_634L',\n    'fortoday_1092L',\n    'forweek_1077L',\n    'forweek_528L',\n    'forweek_601L',\n    'foryear_618L',\n    'foryear_818L',\n    'foryear_850L',\n    'pmtaverage_4955615A',\n    'pmtcount_4955617L',\n    'riskassesment_302T',\n    'riskassesment_940T',\n    'bankacctype_710L',\n    'clientscnt_136L',\n    'equalityempfrom_62L',\n    'interestrategrace_34L',\n    'isbidproductrequest_292L',\n    'lastapprcommoditytypec_5251766M',\n    'lastcancelreason_561M',\n    'lastdependentsnum_448L',\n    'lastotherinc_902A',\n    'lastotherlnsexpense_631A',\n    'lastrejectcommodtypec_5251769M',\n    'lastrepayingdate_696D',\n    'maxannuity_4075009A',\n    'paytype1st_925L',\n    'paytype_783L',\n    'payvacationpostpone_4187118D',\n    'previouscontdistrict_112M',\n    'typesuite_864L',\n    'max_cancelreason_3545846M',\n    'max_district_544M',\n    'max_profession_152M',\n    'max_name_4527232M',\n    'max_name_4917606M',\n    'max_employername_160M',\n    'case_id_right_6',\n    'max_amount_1115A',\n    'max_classificationofcontr_1114M',\n    'max_contractdate_551D',\n    'max_contractmaturitydate_151D',\n    'max_contractst_516M',\n    'max_contracttype_653M',\n    'max_credlmt_1052A',\n    'max_credlmt_228A',\n    'max_credlmt_3940954A',\n    'max_credor_3940957M',\n    'max_credor_3940957M',\n    'max_credquantity_1099L',\n    'max_credquantity_984L',\n    'max_debtpastduevalue_732A',\n    'max_debtvalue_227A',\n    'max_dpd_550P',\n    'max_dpd_733P',\n    'max_dpdmax_851P',\n    'max_dpdmaxdatemonth_804T',\n    'max_dpdmaxdatemonth_804T',\n    'max_dpdmaxdateyear_742T',\n    'max_dpdmaxdateyear_742T',\n    'max_installmentamount_644A',\n    'max_installmentamount_833A',\n    'max_instlamount_892A',\n    'max_interesteffectiverate_369L',\n    'max_interestrateyearly_538L',\n    'max_lastupdate_260D',\n    'max_maxdebtpduevalodued_3940955A',\n    'max_numberofinstls_810L',\n    'max_overdueamountmax_950A',\n    'max_overdueamountmaxdatemonth_494T',\n    'max_overdueamountmaxdatemonth_494T',\n    'max_overdueamountmaxdateyear_432T',\n    'max_overdueamountmaxdateyear_432T',\n    'max_periodicityofpmts_997L',\n    'max_periodicityofpmts_997M',\n    'max_pmtdaysoverdue_1135P',\n    'max_pmtmethod_731M',\n    'max_pmtnumpending_403L',\n    'max_purposeofcred_722M',\n    'max_residualamount_1093A',\n    'max_residualamount_127A',\n    'max_residualamount_3940956A',\n    'max_subjectrole_326M',\n    'max_subjectrole_43M',\n    'max_totalamount_503A',\n    'max_totalamount_881A',\n    'case_id_right_7',\n    'max_amtdebitincoming_4809443A',\n    'max_amtdebitoutgoing_4809440A',\n    'max_amtdepositbalance_4809441A',\n    'max_amtdepositincoming_4809444A',\n    'max_amtdepositoutgoing_4809442A',\n    'max_birthdate_87D',\n    'max_childnum_185L',\n    'max_contaddr_district_15M',\n    'max_contaddr_zipcode_807M',\n    'max_gender_992L',\n    'max_housingtype_772L',\n    'max_isreference_387L',\n    'max_maritalst_703L',\n    'max_registaddr_district_1083M',\n    'max_registaddr_zipcode_184M',\n    'max_role_993L',\n    'max_role_993L',\n    'max_contractenddate_991D',\n    'max_last180dayaveragebalance_704A',\n    'max_last180dayturnover_1134A',\n    'max_last30dayturnover_651A',\n    'case_id_right_11',\n    'max_pmts_date_1107D',\n    'max_pmts_dpdvalue_108P',\n    'max_pmts_pmtsoverdue_635A',\n    \"max_empl_employedtotal_800L\",\n    \"max_empl_industry_691L\",\n ]\n```\n\n```{python} df_train = df_train.drop(removed_cols) df_train ```\n\n```python\ndf_train = df_train.drop(removed_cols)\ndf_train\n```\n\n```python\ndf_test = df_test.drop(removed_cols)\ndf_test\n```\n\n## Last-mile data preprocessing\n\nLast-mile preprocessing is crucial in the machine learning workflow, facilitating accurate\nand efficient training and predictions. We will perform the following transformation\nbefore feeding the data to models:\n- Dropping features with zero variance and redundant features\n- Missing value imputation\n- Encoding categorical variables\n- Handling date variables\n- Handling outliers\n- Scaling and normalization\n\n::: {.callout-note}\nIbisML provides a set of transformations, you could find the roadmap\nin this github [thread](https://github.com/ibis-project/ibis-ml/issues/32) and the guides\nfrom the IbisML [website](https://ibis-project.github.io/ibis-ml/). \n:::\n\n### Drop features\n\n```python\n# Drop features with zero variance for all features For numerical columns, drop featuures\n# with 0 variance For non-numerical columns, drop features with one or fewer unique values\nstep_drop_zero_variance = ml.DropZeroVariance(ml.everything())\n\n# Drop redundant case_id_*\nstep_drop_reduncant_id = ml.Drop(ml.startswith(\"case_id_right_\"))\n```\n\n### Impute features\n\n```python\nstep_impute_mode = ml.ImputeMode(ml.string()) \nstep_impute_median = ml.ImputeMedian(ml.numeric()) ```\n\n### Encode categorical features\n\n```python\ntarget_encoding_step = ml.TargetEncode([\n    \"education_1103M\",\n    \"education_88M\",\n    \"max_education_1138M\",\n    \"max_employername_160M\",\n    \"max_district_544M\",\n    \"previouscontdistrict_112M\",\n    \"lastapprcommoditycat_1041M\",\n    \"lastcancelreason_561M\",\n    \"lastrejectcommoditycat_161M\",\n    \"lastrejectreason_759M\",\n])\n```\n\n```python\nohe_step = ml.OneHotEncode([\n    \"bankacctype_710L\",\n    \"cardtype_51L\",\n    \"credtype_322L\",\n    \"disbursementtype_67L\",\n    \"inittransactioncode_186L\",\n    \"lastapprcommoditytypec_5251766M\",\n    \"lastrejectcommodtypec_5251769M\",\n    \"lastrejectreasonclient_4145040M\",\n    \"lastst_736L\",\n    \"paytype1st_925L\",\n    \"paytype_783L\",\n    \"twobodfilling_608L\",\n    \"max_credtype_587L\",\n    \"max_familystate_726L\",\n    \"max_inittransactioncode_279L\",\n    \"max_postype_4733339M\",\n    \"max_profession_152M\",\n    \"max_rejectreason_755M\",\n    \"max_rejectreasonclient_4145042M\",\n    \"max_status_219L\",\n    \"max_classificationofcontr_1114M\",\n    \"max_contractst_516M\",\n])\n```\n\n### Handle date variables\n\n```python\n# Calculate all the days difference between any date columns and the column `date_decision`\ndate_cols = [col_name for col_name in df_train.columns if col_name[-1] == \"D\"]\ndays_to_decision_expr = {\n        # Difference in days\n        f\"{col}_date_decision_diff\": (_.date_decision.epoch_seconds() - getattr(_, col).epoch_seconds()) / (60 * 60 * 24)\n        for col in date_cols\n}\ndays_to_decision_step = ml.Mutate(days_to_decision_expr)\n```\n\n```python\n# Extract information from the date columns\nexpand_date_step = ml.ExpandDate(ml.date(), [\"week\", \"day\"]) # dow and month is set to catagoery\n```\n\n### Handle outliers\n\n```python\nstep_handle_outliers = ml.HandleUnivariateOutliers([\"days180_256L\"])\n```\n\n### Construct recipe\n\nWe'll construct\n[Recipe](https://ibis-project.github.io/ibis-ml/reference/core.html#ibis_ml.Recipe) by\nchaining all transformation steps, which will be applied to the train and datasets later.\n\n```python\nlast_mile_ml_recipes = ml.Recipe(\n    # Drop cols with 0 variance\n    step_drop_zero_variance,\n    # remove extra case_id_right_*\n    step_drop_reduncant_id,\n\n    # cast bool to int\n    ml.Cast(ml.has_type(\"bool\"), \"float32\"),\n\n    # handle date cols\n    days_to_decision_step,\n    expand_date_step,\n    ml.Drop(ml.date()),\n    ml.Drop([\"MONTH\", \"WEEK_NUM\"]),\n\n    # handle string columns\n    ohe_step,\n    target_encoding_step,\n    step_impute_mode,\n    ml.Drop(ml.string()),\n\n    # handle numeric cols\n    # Capping outliers\n    step_handle_outliers, \n    step_impute_median,\n    ml.ScaleMinMax(ml.numeric()),\n\n    # Fill missing value\n    ml.FillNA(ml.numeric(), 0),\n    ml.Cast(ml.numeric(), \"float32\"),\n)\n```\n\n## Modeling\n\nAfter completing data preprocessing with Ibis and IbisML, we proceed to the modeling\nphase. Here are two approaches:\n\n1. Use IbisML as a independent data preprocessing component and hand off the data to downstream modeling frameworks in various output formats:\n     - Pandas Dataframe\n     - Numpy Array\n     - Polars Dataframe\n     - Dask Dataframe\n     - xgboost.DMatrix\n     - Pyarrow Table\n2. Use IbisML recipes as components within an sklearn Pipeline and  train models similarly to how you would do with sklearn pipeline.\n\nWe will focus on option 1 in this example. You could find option 2 from this\n[tutorial](https://ibis-project.github.io/ibis-ml/tutorial/xgboost.html).\n\n### Train and test data splitting\n\nWe'll use hashing on the unique key to consistently split rows to different groups.\nHashing is robust to underlying changes in the data, such as adding, deleting, or\nreordering rows. This deterministic process ensures that each data point is always\nassigned to the same split, thereby enhancing reproducibility.\n\n```python\nimport random\n\n# This enables the analysis to be reproducible when random numbers are used\nrandom.seed(222) random_key = str(random.getrandbits(256))\n\n# Put 3/4 of the data into the training set\ndf_train = df_train.mutate( train=(df_train.case_id.cast(dt.str) +\nrandom_key).hash().abs() % 4 < 3)\n\ntrain_data = df_train[df_train.train].drop(\"train\") test_data =\ndf_train[~df_train.train].drop(\"train\")\n\nX_train = train_data.drop(\"target\") y_train =\ntrain_data.target.cast(dt.int64).name(\"target\")\n\nX_test = test_data.drop(\"target\") y_test = test_data.target\n```\n\n::: {.callout-warning}\nHashing provides a consistent but pseudo-random distribution of\ndata, which may not precisely align with the specified train/test ratio. While hash codes\nensure reproducibility, they don't guarantee an exact split. Due to statistical variance,\nyou might find a slight imbalance in the distribution, resulting in marginally more or\nfewer samples in either the training or test dataset than the target percentage. This\nminor deviation from the intended ratio is a normal consequence of hash-based\npartitioning. \n:::\n\n### Fit recipe\n\n```python\n# Train preprocessing recipe using training dataset\nlast_mile_ml_recipes.fit(X_train, y_train)\n```\n\n\nIn the previous cell, we trained the recipe using the training dataset. Now, we will\ntransform both the train and test datasets using the same recipe. Data can be outputted by\nIbisML recipes in various formats, such as NumPy, pandas, polars, PyArrow, Dask DataFrame,\nand XGBoost DMatrix, making it compatible with various modeling frameworks. The default\noutput format is `Numpy Array`\n\n```python\n# Transform train and test dataset using IbisML recipe\nX_train_transformed = last_mile_ml_recipes.transform(X_train)\nX_test_transformed = last_mile_ml_recipes.transform(X_test)\n```\n\n### Neural network classifier using pytorch\n\n```python\nimport torch\nimport torch.nn as nn\nimport torch.optim as optim\nfrom torch.utils.data import DataLoader, TensorDataset\nimport pytorch_lightning as pl\nfrom pytorch_lightning import Trainer\n\nclass SimpleNeuralNetClassifier(pl.LightningModule):\n    def __init__(self, input_dim, hidden_dim=64, output_dim=1):\n        super().__init__()\n        self.model = nn.Sequential(\n            nn.Linear(input_dim, hidden_dim),\n            nn.ReLU(),\n            nn.Linear(hidden_dim, output_dim)\n        )\n        self.loss = nn.BCEWithLogitsLoss()  # Binary cross-entropy loss\n        self.sigmoid = nn.Sigmoid()\n\n    def forward(self, x):\n        return self.model(x)\n\n    def training_step(self, batch, batch_idx):\n        x, y = batch\n        y_hat = self(x)\n        loss = self.loss(y_hat.squeeze(), y)\n        self.log('train_loss', loss)\n        return loss\n\n    def validation_step(self, batch, batch_idx):\n        x, y = batch\n        y_hat = self(x)\n        loss = self.loss(y_hat.squeeze(), y)\n        self.log('val_loss', loss)\n        return loss\n\n    def configure_optimizers(self):\n        return optim.Adam(self.parameters(), lr=0.001)\n    \n    def predict_proba(self, x):\n        # Return the probability predictions\n        with torch.no_grad():\n            self.eval()\n            return self.sigmoid(self(x))\n\n# Initialize your LightningModule\nnn_classifier = SimpleNeuralNetClassifier(input_dim=X_train_transformed.shape[1])\n\n# Create PyTorch Lightning data loaders\ntrain_dataset = TensorDataset(\n    torch.Tensor(X_train_transformed),\n    torch.Tensor(y_train.to_pandas().to_numpy())\n)\nval_dataset = TensorDataset(\n    torch.Tensor(X_test_transformed),\n    torch.Tensor(y_test.to_pandas().to_numpy())\n)\ntrain_loader = DataLoader(train_dataset, batch_size=128, shuffle=True)\nval_loader = DataLoader(val_dataset, batch_size=128, shuffle=False)\n\n# Initialize a Trainer\ntrainer = Trainer(max_epochs=2)\n\n# Train the model\ntrainer.fit(nn_classifier, train_loader, val_loader)\n```\n\n```python \ny_pred = nn_classifier.predict_proba( torch.Tensor(X_test_transformed))\ny_pred\n```\n\n### xgboost\n\n```python\nimport xgboost as xgb\n\n# Build a simple xgboost\nxgboost = xgb.XGBClassifier(\n    n_estimators=100,\n    max_depth=4,\n    learning_rate=0.05, \n    subsample=0.8,\n    colsample_bytree=0.8,\n    random_state=42\n)\n# Fit the model using training dataset\nxgboost.fit(X_train_transformed, y_train)\n```\n\n```python\n# Predict\nxgboost.predict_proba(X_train_transformed)[:, 1]\n```\n\n## Reference\n- [1st Place\n  Solution](https://www.kaggle.com/code/yuuniekiri/fork-of-home-credit-risk-lightgbm)\n- [home-credit-2024-starter-notebook](https://www.kaggle.com/code/jetakow/home-credit-2024-starter-notebook)\n- [EDA and\n  Submission](https://www.kaggle.com/competitions/home-credit-credit-risk-model-stability/discussion/508337)\n- [Home Credit Baseline](https://www.kaggle.com/code/greysky/home-credit-baseline)\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}